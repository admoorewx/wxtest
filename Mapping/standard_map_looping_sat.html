<!DOCTYPE html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>Wx Map</title>
        <script>
            L_NO_TOUCH = false;
            L_DISABLE_3D = false;
        </script>

    <style>html, body {width: 100%;height: 100%;margin: 0;padding: 0;}</style>
    <style>#map {position:absolute;top:0;bottom:0;right:0;left:0;}</style>
    <script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.6.0/dist/leaflet.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.js"></script>
    <script src="https://cdn.flexmonster.com/flexmonster.js"></script>
    <!-- Link to example I'm following: https://jsfiddle.net/flexmonster/vnc2h7s8/ -->
    {% load static %}
    <script type="text/javascript" src="{% static '/javascript/Leaflet.windbarb-master/src/leaflet-windbarb.js' %}"></script>
    <script type="text/javascript" src="{% static '/javascript/leaflet.shapefile/leaflet.shpfile.js' %}"></script>
    <script type="text/javascript" src="{% static '/javascript/shapefile-js/dist/shp.js' %}"></script>
    <script type="text/javascript" src="{% static '/javascript/mapping_functions.js' %}"></script>


    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.6.0/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap-theme.min.css"/>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/python-visualization/folium/folium/templates/leaflet.awesome.rotate.min.css"/>

            <meta name="viewport" content="width=device-width,
                initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
            <style>

                #container {
                  position: absolute;
                  height: 100.0%;
                  width: 100.0%;
                  top: 0px;
                  z-index: 0;
                }
                #map_holder {
                    position: absolute;
                    width: 100.0vw;
                    height: 100.0%;
                    left: 0.0%;
                    top: 0.0vh;
                }
                #layerOps {
                  position: absolute;
                  width: 10.0vw;
                  height: 48.0vh;
                  left: 0.0%;
                  top: 4.0vh;
                  background-color:red;
                }
                #actLayers {
                  position: absolute;
                  width: 10.0vw;
                  height: 48.0vh;
                  left: 0.0%;
                  top: 50.0vh;
                  background-color:blue;
                }
                #toolbar {
                  display: none;
                  z-index: 10;
                  position: absolute;
                  width: 40vw;
                  height: 50px;
                  left: 30.0vw;
                  top: 12px;
                  background-color:rgba(80,78,78,0.9);
                  text-align: center;
                  border-color: black;
                  border-width: 2px;
                  border-style: solid;
                  min-width: 500px;
                  overflow: hidden;
                }

                .glm_strike {
                    position: absolute;
                    width:0px;
                    height:0px;
                    color: White;
                    background-color: rgba(0,0,0,0.0);
                    border-color: rgba(0,0,0,0.0);
                    border: 0px;
                    font-size:10px;
                    font-weight: bold;
                    text-shadow: 1px 1px 2px Black;
                    box-shadow: none;
                }

                #MapView {
                  text-align: center;
                }
                #RadarSelect {
                  text-align: center;
                }
                #SatSelect {
                  text-align: center;
                }
                #HazSelect {
                  text-align: center;
                }
                #SfcSelect {
                  text-align: center;
                }
                .spc_box{
                  top: 10px;
                }
                .fire_box{
                  top: 30px;
                }
                .text-label {
                    position: absolute;
                    width:0px;
                    height:0px;
                    background-color: rgba(0,0,0,0.0);
                    border-color: rgba(0,0,0,0.0);
                    border: 0px;
                    font-size:12px;
                    font-weight: bold;
                    text-shadow: 0 0 4px Black;
                    box-shadow: none;
                }
                .leaflet-tooltip-top:before,
                .leaflet-tooltip-bottom:before,
                .leaflet-tooltip-left:before,
                .leaflet-tooltip-right:before {
                  background-color: rgba(0,0,0,0.0);
                  border:none;
                  box-shadow:none;
                }

                #menu_button{
                  position: relative;
                  z-index: 10;
                  left:50px;
                  top:12px;
                  height:50px;
                  width: 75px;
                  color: white;
                  background-color: rgba(80,78,78,0.9);
                }

                .menu_option{
                  height: 100.0%;
                  width: 100.0%;
                  border-color: black;
                  border-width: 0px;
                  border-style: solid;
                }

                /* ---- Map Button ---- */
                #mapmenu{
                  display: inline-block;
                  position: absolute;
                  height: 100.0%;
                  width: 10.0%;
                  left: 6.0%;
                }
                #map_button{
                  background: url({% static '/media/icons/worldwide.png' %}) no-repeat top;
                  background-color: transparent;
                  background-size: 100.0% 100.0%;
                }

                .mapcontent{
                  position: fixed;
                  display: none;
                  z-index: 11;
                  width:200px;
                  height:150px;
                }

                .mapcontent a {
                  color: white;
                  display: block;
                  background-color: rgba(80,78,78,0.9);
                  cursor: pointer;
                }

                .mapcontent a:hover {background-color: gray;}
                #mapmenu:hover .mapcontent {display: block;}
                #mapmenu:hover #map_button {background-color: rgba(56,82,142,1.0); border-width: 1px;}

                /* ---- Satellite Button ---- */
                #satmenu{
                  display: inline-block;
                  position: absolute;
                  height: 100.0%;
                  width: 10.0%;
                  left: 19.0%;
                }
                #sat_button{
                  background: url({% static '/media/icons/satellite.png' %}) no-repeat top;
                  background-color: transparent;
                  background-size: 100.0% 100.0%;
                }

                .satcontent{
                  position: fixed;
                  display: none;
                  z-index: 11;
                  width:200px;
                  height:150px;
                }

                .satcontent a {
                  color: white;
                  display: block;
                  width: 300px;
                  background-color: rgba(80,78,78,0.9);
                  cursor: pointer;
                }

                .satcontent a:hover {background-color: gray;}
                #satmenu:hover .satcontent {display: block;}
                #satmenu:hover #sat_button {background-color: rgba(56,82,142,1.0); border-width: 1px;}


                /* ---- GLM Button ---- */
                #glmmenu{
                  display: inline-block;
                  position: absolute;
                  height: 100.0%;
                  width: 10.0%;
                  left: 32.0%;
                }
                #glm_button{
                  background: url({% static '/media/icons/flash.png' %}) no-repeat top;
                  background-color: transparent;
                  background-size: 98.0% 98.0%;
                }

                .glmcontent{
                  position: fixed;
                  display: none;
                  z-index: 11;
                  width:200px;
                  height:150px;
                }

                .glmcontent a {
                  color: white;
                  display: block;
                  background-color: rgba(80,78,78,0.9);
                  cursor: pointer;
                }

                .glmcontent a:hover {background-color: gray;}
                #glmmenu:hover .glmcontent {display: block;}
                #glmmenu:hover #glm_button {background-color: rgba(56,82,142,1.0); border-width: 1px;}



                /* ---- Radar Button ---- */
                #radmenu{
                  display: inline-block;
                  position: absolute;
                  height: 100.0%;
                  width: 10.0%;
                  left: 45.0%;
                }
                #rad_button{
                  background: url({% static '/media/icons/radar2.png' %}) no-repeat top;
                  background-color: transparent;
                  background-size: 100.0% 100.0%;
                }

                .radcontent{
                  position: fixed;
                  display: none;
                  z-index: 11;
                  width:200px;
                  height:150px;
                }

                .radcontent a {
                  color: white;
                  display: block;
                  background-color: rgba(80,78,78,0.9);
                  cursor: pointer;
                }

                .radcontent a:hover {background-color: gray;}
                #radmenu:hover .radcontent {display: block;}
                #radmenu:hover #rad_button {background-color: rgba(56,82,142,1.0); border-width: 1px;}


                /* ---- Hazard Button ---- */
                #hazmenu{
                  display: inline-block;
                  position: absolute;
                  height: 100.0%;
                  width: 10.0%;
                  left: 58.0%;
                }
                #haz_button{
                  background: url({% static '/media/icons/warning.png' %}) no-repeat top;
                  background-color: transparent;
                  background-size: 100.0% 100.0%;
                }

                .hazcontent{
                  position: fixed;
                  display: none;
                  z-index: 11;
                  width:200px;
                  height:150px;
                }

                .hazcontent a {
                  color: white;
                  display: block;
                  background-color: rgba(80,78,78,0.9);
                  cursor: pointer;
                }

                .hazcontent a:hover {background-color: gray;}
                #hazmenu:hover .hazcontent {display: block;}
                #hazmenu:hover #haz_button {background-color: rgba(56,82,142,1.0); border-width: 1px;}

                /* ---- Surface Button ---- */
                #sfcmenu{
                  display: inline-block;
                  position: absolute;
                  height: 100.0%;
                  width: 10.0%;
                  left: 71.0%;
                }
                #sfc_button{
                  background: url({% static '/media/icons/windsock.png' %}) no-repeat top;
                  background-color: transparent;
                  background-size: 100.0% 100.0%;
                }

                .sfccontent{
                  position: fixed;
                  display: none;
                  z-index: 11;
                  width:200px;
                  height:150px;
                }

                .sfccontent a {
                  color: white;
                  display: block;
                  background-color: rgba(80,78,78,0.9);
                  cursor: pointer;
                }

                .sfccontent a:hover {background-color: gray;}
                #sfcmenu:hover .sfccontent {display: block;}
                #sfcmenu:hover #sfc_button {background-color: rgba(56,82,142,1.0); border-width: 1px;}

                /* ---- Outlook Button ---- */
                #outmenu{
                  display: inline-block;
                  position: absolute;
                  height: 100.0%;
                  width: 10.0%;
                  left: 84.0%;
                }
                #out_button{
                  background: url({% static '/media/icons/storm.png' %}) no-repeat top;
                  background-color: transparent;
                  background-size: 100.0% 100.0%;
                }

                .outcontent{
                  position: fixed;
                  display: none;
                  z-index: 11;
                  width:200px;
                  height:150px;
                }

                .outcontent a {
                  color: white;
                  display: block;
                  background-color: rgba(80,78,78,0.9);
                  cursor: pointer;
                }

                .outcontent a:hover {background-color: gray;}
                #outmenu:hover .outcontent {display: block;}
                #outmenu:hover #out_button {background-color: rgba(56,82,142,1.0); border-width: 1px;}


            </style>

</head>
<body>
{% block content %}
  <button id="menu_button" onclick="showToolbar()">Show Menu</button>

  <div class="toolBar" id="toolbar">

    <div id="mapmenu">
      <button type="button" class="menu_option" id="map_button"></button>
      <div class="mapcontent">
        <a onclick="changeMapView(map,'WORLD')">World</a>
        <a onclick="changeMapView(map,'NORTHAM')">North America</a>
        <a onclick="changeMapView(map,'CONUS')">CONUS</a>
        <a onclick="changeMapView(map,'NW')">Northwest</a>
        <a onclick="changeMapView(map,'NP')">Northern Plains</a>
        <a onclick="changeMapView(map,'NE')">Northeast</a>
        <a onclick="changeMapView(map,'CP')">Central Plains</a>
        <a onclick="changeMapView(map,'CR')">Central Rockies</a>
        <a onclick="changeMapView(map,'SW')">Southwest</a>
        <a onclick="changeMapView(map,'SP')">Southern Plains</a>
        <a onclick="changeMapView(map,'SE')">Southeast</a>
        <a onclick="changeMapView(map,'MW')">Midwest</a>

      </div>
    </div>

    <div id="satmenu">
      <button type="button" class="menu_option" id="sat_button"></button>
      <div class="satcontent">
        <a onclick="changeSat2(map,'NONE',times)">NONE</a>
        <a>------- CONUS -------</a>
        <a onclick="changeSat2(map,'G16ch02',times)">GOES-16 CONUS Ch. 2 Visible</a>
        <a onclick="changeSat2(map,'G16ch13',times)">GOES-16 CONUS Ch. 13 Clean IR</a>
      </div>
    </div>

    <div id="glmmenu">
      <button type="button" class="menu_option" id="glm_button"></button>
      <div class="glmcontent">
        <a>--- Coming Soon! ---</a>
        <!-- <a onclick="triggerGLM(false)">NONE</a>
        <a onclick="triggerGLM(true)">GLM Flash Events</a> -->
      </div>
    </div>

    <div id="radmenu">
      <button type="button" class="menu_option" id="rad_button"></button>
      <div class="radcontent">
        <a onclick="changeRadar(map,'NONE')">NONE</a>
        <a onclick="changeRadar(map,'IEM Base Refl.')">IEM Base Reflectivity</a>
      </div>
    </div>

    <div id="sfcmenu">
      <button type="button" class="menu_option" id="sfc_button"></button>
      <div class="sfccontent">
        <a onclick="updateSFC('NONE')">NONE</a>
        <a onclick="updateSFC('STANDARD')">Standard</a>
        <a onclick="updateSFC('RLT')">RLT Obs</a>
        <a onclick="updateSFC('TEMP')">Temperature</a>
        <a onclick="updateSFC('DEWP')">Dewpoint</a>
        <a onclick="updateSFC('WIND')">Winds</a>
        <a onclick="updateSFC('FIRE')">RH + Winds</a>
        <a onclick="updateSFC('VISB')">Visibility</a>
      </div>
    </div>

    <div id="hazmenu">
      <button type="button" class="menu_option" id="haz_button"></button>
      <div class="hazcontent">
        <a onclick="changeHaz(map,'NONE')">NONE</a>
        <a onclick="changeHaz(map,'all')">All Hazards</a>
        <a onclick="changeHaz(map,'long')">Long-Duration Hazards</a>
        <a onclick="changeHaz(map,'short')">Convective Warnings</a>
        <a onclick="changeHaz(map,'watch')">Convective Watches</a>
        <a onclick="changeHaz(map,'convective')">Convective Watch/Warnings</a>
      </div>
    </div>

    <div id="outmenu">
      <button type="button" class="menu_option" id="out_button"></button>
      <div class="outcontent">
        <a onclick="changeOut(map,'NONE')">NONE</a>
        <a onclick="changeOut(map,'spcd1cat')">SPC Day 1 Categorical</a>
        <a onclick="changeOut(map,'spcd1fire')">SPC Day 1 Fire</a>
      </div>
    </div>

  </div>



  <div id="container">
    Hello
    <div class="folium-map" id="map_holder"></div>

  </div>

</body>
<script>

///////////////////////////////// Sat, Rad, GLM, sfc obs, Time settings //////////////////////////////////////////////
            var update = 10; // seconds
            var interval = 12; // number of frames
            var times = createTimeArray(interval); // create list of times
            var currentIndex = 0;
            var previousIndex = interval;
            // this is the initial creation. The update timer is at the end of the script
///////////////////////////////// Handles hiding/showing the toolbar //////////////////////////////////////////////
            var showMenu = false;
            function showToolbar() {
              if (!showMenu){
                $('#menu_button').text("Hide Menu");
                showMenu = true;
                $('#toolbar').css({display: "block"});
                $('#menu_button').css({"background-color": "rgba(56,82,142,1.0)", color: "white"});
              } else {
                $('#menu_button').text("Show Menu");
                $('#menu_button').css({"background-color": "rgba(80,78,78,0.9)", color: "white"});
                showMenu = false;
                $('#toolbar').css({display: "none"});
              } // end else
            } // end showToolbar function

///////////////////////////////// Handles centering the toolbar //////////////////////////////////////////////
            window.addEventListener('resize', function(){
              var width = window.innerWidth;
              var tbwidth = width * 0.4;
              var left = width * 0.3;
              $('#toolbar').css({width: `"${tbwidth}"`, left: `"${left}"`});
            });
///////////////////////////////// MOUSE LAT/LON FUNCTIONS //////////////////////////////////////////////

            L.CursorHandler = L.Handler.extend({
                addHooks: function () {
                    this._map.on('mousemove', this._update, this);
                },
                _update: function (e) {
                  document.getElementById('label').innerHTML = e.latlng.lat.toFixed(4).toString()+", "+e.latlng.lng.toFixed(4).toString();
                }
            });
            L.Map.addInitHook('addHandler', 'cursor', L.CursorHandler);


/////////////////////////////////////// BOUNDARY CONTROL //////////////////////////////////////////////
            var county_style = {
                "color":"#F7F3F3",
                "fillColor":"none",
                "fillOpacity":0.0,
                "opacity":0.4,
                "weight": 0.5,
            }
            var state_style = {
                "color":"#F7F3F3",
                "fillColor":"none",
                "fillOpacity":0.0,
                "opacity":0.9,
                "weight": 0.9,
            }

            var cwa_style = {
                "color":"#FFDB49",
                "fillColor":"none",
                "fillOpacity":0.0,
                "opacity":0.9,
                "weight": 1.2,
            }

            var district_boundary = new L.geoJson();
            $.ajax({
            dataType: "json",
            url: "{% static '/geo/boundaries/uscounties.json' %}",
            success: function(data) {
                $(data.features).each(function(key, data) {
                    district_boundary.addData(data).setStyle(county_style);
                    //district_boundary.setStyle(county_style);
                });
            }
            }).error(function() {});

            var state_boundary = new L.geoJson();
            $.ajax({
            dataType: "json",
            url: "{% static '/geo/boundaries/usstates.json' %}",
            success: function(data) {
                $(data.features).each(function(key, data) {
                    state_boundary.addData(data);
                    state_boundary.setStyle(state_style);
                });
            }
            }).error(function() {});


            var cwa_boundary = new L.geoJson();
            $.ajax({
            dataType: "json",
            url: "{% static '/geo/boundaries/cwa/cwa.geojson' %}",
            success: function(data) {
                $(data.features).each(function(key, data) {
                    cwa_boundary.addData(data);
                    cwa_boundary.setStyle(cwa_style);
                });
            }
            }).error(function() {});

///////////////////////////////////////// MAP DEFINITION //////////////////////////////////////////////
            var map = L.map(
                "map_holder",
                {
                    center: [40.0, -100.0],
                    crs: L.CRS.EPSG3857,
                    zoom: 5,
                    zoomControl: true,
                    cursor: true,
                    preferCanvas: true,
                    renderer: L.canvas(),
                    keyboard: false,
                    updateWhenIdle: true,
                    updateWhenZooming: false,
                }
            );
            var obsCanvas = L.canvas(); // for surface observations
            /////////////// BASE LAYERS /////////////////
            var dark = L.tileLayer(
                "https://cartodb-basemaps-{s}.global.ssl.fastly.net/dark_all/{z}/{x}/{y}.png",
                {"attribution": "\u0026copy; \u003ca href=\"http://www.openstreetmap.org/copyright\"\u003eOpenStreetMap\u003c/a\u003e contributors \u0026copy; \u003ca href=\"http://cartodb.com/attributions\"\u003eCartoDB\u003c/a\u003e, CartoDB \u003ca href =\"http://cartodb.com/attributions\"\u003eattributions\u003c/a\u003e", "detectRetina": false, "maxNativeZoom": 18, "maxZoom": 18, "minZoom": 0, "noWrap": false, "opacity": 1, "subdomains": "abc", "tms": false}
            ).addTo(map);

            var light = L.tileLayer(
                "https://stamen-tiles-{s}.a.ssl.fastly.net/toner/{z}/{x}/{y}.png",
                {"attribution": "Map tiles by \u003ca href=\"http://stamen.com\"\u003eStamen Design\u003c/a\u003e, under \u003ca href=\"http://creativecommons.org/licenses/by/3.0\"\u003eCC BY 3.0\u003c/a\u003e. Data by \u0026copy; \u003ca href=\"http://openstreetmap.org\"\u003eOpenStreetMap\u003c/a\u003e, under \u003ca href=\"http://www.openstreetmap.org/copyright\"\u003eODbL\u003c/a\u003e.", "detectRetina": false, "maxNativeZoom": 18, "maxZoom": 18, "minZoom": 0, "noWrap": false, "opacity": 1, "subdomains": "abc", "tms": false}
            );

            var osm = L.tileLayer(
                "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
                {"attribution": "Data by \u0026copy; \u003ca href=\"http://openstreetmap.org\"\u003eOpenStreetMap\u003c/a\u003e, under \u003ca href=\"http://www.openstreetmap.org/copyright\"\u003eODbL\u003c/a\u003e.", "detectRetina": false, "maxNativeZoom": 18, "maxZoom": 18, "minZoom": 0, "noWrap": false, "opacity": 1, "subdomains": "abc", "tms": false}
            );

            var esri_phyiscal = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Physical_Map/MapServer/tile/{z}/{y}/{x}', {
            	attribution: 'Tiles &copy; Esri &mdash; Source: US National Park Service',
            });

            var world_imagery = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            	attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
            });

            var esri_map = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Specialty/DeLorme_World_Base_Map/MapServer/tile/{z}/{y}/{x}', {
            	attribution: 'Tiles &copy; Esri &mdash; Copyright: &copy;2012 DeLorme',
            	minZoom: 1,
            	maxZoom: 11
            });

            /////////////// ADDITIONAL LAYERS //////////////
            var interstates = new L.Shapefile("{% static '/geo/interstate/interstate_shapefile' %}",{"opacity":"0.9", "color":"#0303e9", "weight":"0.9"}); //#25FF34
            var interstates = new L.Shapefile("{% static '/geo/interstate/interstate_shapefile' %}",{"opacity":"0.9", "color":"#25FF34", "weight":"0.8"});

            /////////////// LAYER CONTROL ////////////////
            var layer_control_1 = {
                base_layers : {
                    "Dark (default)" : dark,
                    "Light" : light,
                    "Open Street Map" : osm,
                    "World Imagery": world_imagery,
                    "ESRI Map": esri_map,
                    "ESRI Physical": esri_phyiscal,
                }, overlays : {
                  "States": state_boundary,
                  "Counties": district_boundary,
                  "NWS CWAs": cwa_boundary,
                  "Interstates": interstates,
                }
            };
            L.control.layers(layer_control_1.base_layers,
                            layer_control_1.overlays,
                            {"autoZIndex": true, "collapsed": true, "position": "topright"}
                            ).addTo(map);


            // initialize the state boundaries by default
            state_boundary.addTo(map);




///////////////////////////////// RADAR SECTION //////////////////////////////////////////////
            var radType = 'none'; // initialize the satellite type
            var radOpac = 0.0; // initialize the satellite opacity
            var rad_imgs = []; // initialize the image array
            var showRad = false;
            // this function controls pre-loading the image overlays
            function loadRadar(type,times,opacity){
              rad_imgs = [];
              var rbase = "/static/data/radar/conus_basemosaic_";
              var rend = ".png";
              var radURLs = getURLS(rbase,times,rend);
              //console.log(goesURLs);
              var rad_bounds = [[10.1,-126.0],[57.9,-65.0]];
              rad_1 = L.imageOverlay(radURLs[0],rad_bounds).setOpacity(opacity).addTo(map);
              rad_2 = L.imageOverlay(radURLs[1],rad_bounds).setOpacity(opacity).addTo(map);
              rad_3 = L.imageOverlay(radURLs[2],rad_bounds).setOpacity(opacity).addTo(map);
              rad_4 = L.imageOverlay(radURLs[3],rad_bounds).setOpacity(opacity).addTo(map);
              rad_5 = L.imageOverlay(radURLs[4],rad_bounds).setOpacity(opacity).addTo(map);
              rad_6 = L.imageOverlay(radURLs[5],rad_bounds).setOpacity(opacity).addTo(map);
              rad_7 = L.imageOverlay(radURLs[6],rad_bounds).setOpacity(opacity).addTo(map);
              rad_8 = L.imageOverlay(radURLs[7],rad_bounds).setOpacity(opacity).addTo(map);
              rad_9 = L.imageOverlay(radURLs[8],rad_bounds).setOpacity(opacity).addTo(map);
              rad_10 = L.imageOverlay(radURLs[9],rad_bounds).setOpacity(opacity).addTo(map);
              rad_11 = L.imageOverlay(radURLs[10],rad_bounds).setOpacity(opacity).addTo(map);
              rad_12 = L.imageOverlay(radURLs[11],rad_bounds).setOpacity(opacity).addTo(map);
              //rad_13 = L.imageOverlay(radURLs[12],rad_bounds).setOpacity(opacity).addTo(map);
              //rad_14 = L.imageOverlay(radURLs[13],rad_bounds).setOpacity(opacity).addTo(map);
              //rad_15 = L.imageOverlay(radURLs[14],rad_bounds).setOpacity(opacity).addTo(map);
              rad_imgs.push(rad_1,rad_2,rad_3,rad_4,rad_5,rad_6,rad_7,rad_8,rad_9,rad_10,rad_11,rad_12);
              // this loads the images in prior to displaying the current image in "loadRadar" below
              for (i=0;i<rad_imgs.length;i++){
                map.removeLayer(rad_imgs[i])
              }
              displayRadar(showRad);
          }// end loadGOES

          // this function handles changing GOES image types/channels
          function changeRadar(map,rad){
            globalThis.radType = rad;
            if (rad === "NONE"){
              type = "none";
              globalThis.radOpac = 0.0;
              globalThis.showRad = false;
              displayRadar(false);
            }
            else if (rad == "IEM Base Refl.") {
              type = "IEM Base Refl.";
              globalThis.radOpac = 0.6;
              globalThis.showRad = true;
              loadRadar(type,times,0.6);
              //displayRadar(true);
            }
          } // end changeSat2

          // this function handles displaying the GOES images
          function displayRadar(show){
            if(show && radType != "none" && radType != "NONE"){
            // if(show && radType != "none" && radType != "NONE"){
              rad_imgs[currentIndex].addTo(map);
              try{
                setTimeout(function() {map.removeLayer(rad_imgs[previousIndex])},0.1);
              }
              catch{
                console.log("No layer to remove.");
              }
              changeRadarTimestamp(true);
            } else {
              for(i=0;i<rad_imgs.length;i++){
                map.removeLayer(rad_imgs[i]);
              }
              changeRadarTimestamp(false);
            }
          }

///////////////////////////////// GOES SECTION //////////////////////////////////////////////
            var satType = 'none'; // initialize the satellite type
            var satOpac = 0.0; // initialize the satellite opacity
            var sat_imgs = []; // initialize the image array
            var showsat = false;
            // this function controls pre-loading the image overlays
            function loadSat(type,times,opacity){
              type = type.substring(5);
              var rbase = "/static/data/goes/g16conus/G16_conus_Ch"+type+"_";
              var rend = ".png";
              var satURLs = getURLS(rbase,times,rend);
              //console.log(goesURLs);
              // remove the old images first if we're changing from one channel to another
              try {
                for (i=0;i<sat_imgs.length;i++){
                  map.removeLayer(sat_imgs[i])
                }
              } catch {
                console.log("No previous channel");
              } // end try/catch
              sat_imgs = [];
              var sat_bounds = [[14.57134,-151.73],[56.7,-52.899]];
              sat_1 = L.imageOverlay(satURLs[0],sat_bounds).setOpacity(opacity).addTo(map);
              sat_2 = L.imageOverlay(satURLs[1],sat_bounds).setOpacity(opacity).addTo(map);
              sat_3 = L.imageOverlay(satURLs[2],sat_bounds).setOpacity(opacity).addTo(map);
              sat_4 = L.imageOverlay(satURLs[3],sat_bounds).setOpacity(opacity).addTo(map);
              sat_5 = L.imageOverlay(satURLs[4],sat_bounds).setOpacity(opacity).addTo(map);
              sat_6 = L.imageOverlay(satURLs[5],sat_bounds).setOpacity(opacity).addTo(map);
              sat_7 = L.imageOverlay(satURLs[6],sat_bounds).setOpacity(opacity).addTo(map);
              sat_8 = L.imageOverlay(satURLs[7],sat_bounds).setOpacity(opacity).addTo(map);
              sat_9 = L.imageOverlay(satURLs[8],sat_bounds).setOpacity(opacity).addTo(map);
              sat_10 = L.imageOverlay(satURLs[9],sat_bounds).setOpacity(opacity).addTo(map);
              sat_11 = L.imageOverlay(satURLs[10],sat_bounds).setOpacity(opacity).addTo(map);
              sat_12 = L.imageOverlay(satURLs[11],sat_bounds).setOpacity(opacity).addTo(map);
              //sat_13 = L.imageOverlay(satURLs[12],sat_bounds).setOpacity(opacity).addTo(map);
              //sat_14 = L.imageOverlay(satURLs[13],sat_bounds).setOpacity(opacity).addTo(map);
              //sat_15 = L.imageOverlay(satURLs[14],sat_bounds).setOpacity(opacity).addTo(map);
              sat_imgs.push(sat_1,sat_2,sat_3,sat_4,sat_5,sat_6,sat_7,sat_8,sat_9,sat_10,sat_11,sat_12);
              // this loads the images in prior to displaying the current image in "loadRadar" below
              for (i=0;i<sat_imgs.length;i++){
                map.removeLayer(sat_imgs[i])
              }
              displaySat(showsat);
          }// end loadGOES

          // this function handles changing GOES image types/channels
          function changeSat2(map,sat,times){
            globalThis.satType = sat;
            if (sat === "NONE"){
              type = "none";
              globalThis.satOpac = 0.0;
              globalThis.showsat = false;
              displaySat(false);
            }
            else if (sat == "G16ch02") {
              globalThis.satOpac = 0.6;
              globalThis.showsat = true;
              loadSat(satType,times,satOpac);
              //displayRadar(true);
            }
            else if (sat == "G16ch13") {
              globalThis.satOpac = 0.6;
              globalThis.showsat = true;
              loadSat(satType,times,satOpac);
              //displayRadar(true);
            }
          } // end changeSat2

          // this function handles displaying the GOES images
          function displaySat(show){
            if(show && satType != "none" && satType != "NONE"){
              sat_imgs[currentIndex].addTo(map);
              try{
                map.removeLayer(sat_imgs[previousIndex]);
              } catch {
                console.log("No sat layer to remove");
              }
              changeGOESTimestamp(true);
            } else {
              for(i=0;i<sat_imgs.length;i++){
                map.removeLayer(sat_imgs[i]);
              }
              changeGOESTimestamp(false);
            }
          } // end function

// ///////////////////////////////// GLM SECTION //////////////////////////////////////////////
//             // Declare some initial feature groups and important variables
//             var glm_1 = L.featureGroup();
//             // var glm_2 = L.featureGroup();
//             // var glm_3 = L.featureGroup();
//             // var glm_4 = L.featureGroup();
//             // var glm_5 = L.featureGroup();
//             // var glm_6 = L.featureGroup();
//             // var glm_7 = L.featureGroup();
//             // var glm_8 = L.featureGroup();
//             // var glm_9 = L.featureGroup();
//             // var glm_10 = L.featureGroup();
//             // var glm_11 = L.featureGroup();
//             // var glm_12 = L.featureGroup();
//             var glm_imgs = [];
//             var showGLM = false;
//
//             // reads in the JSON files and updates the feature groups
//             function getGLMgroups(time,group){
//               glm_file = "/static/data/goes/glm/G16_conus_GLM_"+time.toString()+".json";
//               group.clearLayers();
//               $.ajax({
//               dataType: "json",
//               url: glm_file,
//               success: function(data) {
//                   $.each(data, function(key,info){
//                     let lat = info.Lat;
//                     let lon = info.Lon;
//                     var marker = new L.marker([lat, lon], { opacity: 0.0 }); //opacity may be set to zero
//                     marker.bindTooltip(`<p style="margin-bottom:0;">+</p>`, {permanent: true, className: "glm_strike", direction:'center' });
//                     marker.addTo(group);
//                   });
//               }
//               }).error(function() {});
//               return group;
//             }
//
//             // controls pre-loading the GLM feature groups
//             function loadGLM(times){
//               glm_imgs = [];
//               glm_1 = getGLMgroups(times[0],glm_1);
//               // glm_2 = getGLMgroups(times[1],glm_2);
//               // glm_3 = getGLMgroups(times[2],glm_3);
//               // glm_4 = getGLMgroups(times[3],glm_4);
//               // glm_5 = getGLMgroups(times[4],glm_5);
//               // glm_6 = getGLMgroups(times[5],glm_6);
//               // glm_7 = getGLMgroups(times[6],glm_7);
//               // glm_8 = getGLMgroups(times[7],glm_8);
//               // glm_9 = getGLMgroups(times[8],glm_9);
//               // glm_10 = getGLMgroups(times[9],glm_10);
//               // glm_11 = getGLMgroups(times[10],glm_11);
//               // glm_12 = getGLMgroups(times[11],glm_12);
//               // glm_imgs.push(glm_1,glm_2,glm_3,glm_4,glm_5,glm_6,glm_7,glm_8,glm_9,glm_10,glm_11,glm_12);
//           }
//
//           // this function changes the trigger for showing glm
//           // this can only be activated by a user's button input
//           function triggerGLM(show){
//             globalThis.showGLM = show;
//             loadGLM(times);
//             displayGLM(show);
//           }
//
//           // controls actually showing the GLM data
//           function displayGLM(showGLM){
//             for(i=0;i<glm_imgs.length;i++){
//               map.removeLayer(glm_imgs[i]);
//             }
//             if (showGLM){
//               glm_imgs[0].addTo(map);
//               changeGLMTimestamp(showGLM);
//             } else {
//               changeGLMTimestamp(showGLM);
//             }
//             // for(i=0;i<glm_imgs.length;i++){
//             //   map.removeLayer(glm_imgs[i]);
//             // }
//             // if(showGLM){
//             //   glm_imgs[currentIndex].addTo(map);
//             //   try{
//             //     setTimeout(function() {map.removeLayer(glm_imgs[previousIndex])},250);
//             //   }
//             //   catch{
//             //     console.log("No layer to remove.");
//             //   }
//             //   changeGLMTimestamp(showGLM);
//             // } else {
//             //   for(i=0;i<glm_imgs.length;i++){
//             //     map.removeLayer(glm_imgs[i]);
//             //   }
//             //   changeGLMTimestamp(showGLM);
//             // }
//           }
//


////////////////////////// outlooks /////////////////////////////
            var spc_day1_cat = new L.layerGroup();
            var fire_day1 = new L.layerGroup();
            function createOutlooks(){
              console.log("Refreshing Outlooks");
              var day1_cat_data = new L.Shapefile("{% static '/forecasts/outlooks/spc/day1/day1otlk_cat' %}",{
                onEachFeature:function(feature,layer){
                  let dn = feature.properties.DN;
                  let color = spcCatColor(dn);
                  layer.setStyle({"color":color, "opacity":"0.03"});
                  spc_day1_cat.addLayer(layer);
                }
              });
              var day1_fire_data = new L.Shapefile("{% static '/forecasts/outlooks/spc_fire/day1/firewx_day1' %}",{
                onEachFeature:function(feature,layer){
                  let dn = feature.properties.DN;
                  let color = fireCatColor(dn);
                  layer.setStyle({"color":color, "opacity":"0.03"});
                  fire_day1.addLayer(layer);
                }
              });
            } // end function createOutlooks


            var outlookTimers = [];
            function changeOut(map,out){
              //var rad = document.getElementById("HazSelect").value;
              // clear layers
              spc_day1_cat.clearLayers();
              fire_day1.clearLayers();
              // remove layers
              spc_day1_cat.remove();
              fire_day1.remove();

              clearTimers(outlookTimers);

              if (out == "NONE"){
                spc_day1_cat.remove();
                fire_day1.remove();
                changeOUTtext(out,false)
              }
              else if (out === "spcd1cat") {
                createOutlooks();
                spc_day1_cat.addTo(map);
                changeOUTtext("SPC Day 1 Convective", true)
                var spcd1catTimer = setInterval(function(){
                  spc_day1_cat.clearLayers();
                  spc_day1_cat.remove();
                  createOutlooks();
                  spc_day1_cat.addTo(map);
                  changeOUTtext("SPC Day 1 Convective", true)
                },(30*60*1000)); // update every 30 minutes
                outlookTimers.push(spcd1catTimer);
              }
              else if (out === "spcd1fire") {
                createOutlooks();
                fire_day1.addTo(map);
                changeOUTtext("SPC Day 1 Fire", true)
                var fired1Timer = setInterval(function(){
                  fire_day1.clearLayers();
                  fire_day1.remove();
                  createOutlooks();
                  fire_day1.addTo(map);
                  changeOUTtext("SPC Day 1 Fire", true)
                },(30*60*1000)); // update every 30 minutes
                outlookTimers.push(fired1Timer);
              }
              else {
                spc_day1_cat.remove();
                fire_day1.remove();
              }
            } // end function changeOut
///////////////////////////////// HAZARDS AND WARNINGS //////////////////////////////////////////////
            var current_warnings = new L.layerGroup();
            var current_hazards = new L.layerGroup();
            var convective_watches = new L.layerGroup();
            function createHazards(){
              console.log("Updating Hazards...");
              var times = getHazardTimes();
              let url = '/static/forecasts/hazards/current_hazards/current_hazards_'+times[0]+'.shp';
              var exists = checkFileExists(url);
              if (exists){
                filestring = '/static/forecasts/hazards/current_hazards/current_hazards_'+times[0];
              } else {
                filestring = '/static/forecasts/hazards/current_hazards/current_hazards_'+times[1];
              }
              var hazard_data = new L.Shapefile(filestring,{
                onEachFeature:function(feature,layer){
                  let type = feature.properties.PROD_TYPE;
                  if (type.includes("Severe Thunderstorm Warning") || type.includes("Tornado Warning") || type.includes("Flash Flood Warning")){
                    // do nothing, these are handled elsewhere.
                  }
                  else if (type.includes("Severe Thunderstorm Watch") || type.includes("Tornado Watch")){
                    let color = hazardColor(type);
                    let issuance = feature.properties.ISSUANCE.substring(0,10) + " " + feature.properties.ISSUANCE.substring(11,16) + " LT";
                    let expiration = feature.properties.EXPIRATION.substring(0,10) + " " + feature.properties.EXPIRATION.substring(11,16) + " LT";
                    let wfo = feature.properties.WFO;
                    let url = "https://www.spc.noaa.gov/products/watch/";
                    let text = `Hazard Type: ${type} <br>
                                Issued by WFO: ${wfo.substring(1)} <br>
                                Start Time: ${issuance} <br>
                                End Time: ${expiration} <br>`
                    let ref = `<a href=${url}>More Info Here</a>`;
                    text = text + ref;
                    layer.bindPopup(text);
                    layer.setStyle({"color":color, "weight":"0.4", "opacity":"0.55"});
                    convective_watches.addLayer(layer);
                  } // end if
                  else {
                    let color = hazardColor(type);
                    let issuance = feature.properties.ISSUANCE.substring(0,10) + " " + feature.properties.ISSUANCE.substring(11,16) + " LT";
                    let expiration = feature.properties.EXPIRATION.substring(0,10) + " " + feature.properties.EXPIRATION.substring(11,16) + " LT";
                    let wfo = feature.properties.WFO;
                    let url = feature.properties.URL;
                    let text = `Hazard Type: ${type} <br>
                                Issued by WFO: ${wfo.substring(1)} <br>
                                Start Time: ${issuance} <br>
                                End Time: ${expiration} <br>`
                    let ref = `<a href=${url}>More Info Here</a>`;
                    text = text + ref;
                    layer.bindPopup(text);
                    if (type.includes("Warning")){
                      layer.setStyle({"color":color, "weight":"0.5", "opacity":"0.65", "fillOpacity":"0.5"});
                      layer.bringToFront();
                    } else {
                      layer.setStyle({"color":color, "weight":"0.5", "opacity":"0.65", "fillOpacity":"0.5"});
                      layer.bringToBack();
                    } // end else
                    current_hazards.addLayer(layer);
                  } // end else
                } // end for each feature
              }); // end shapefile layer
              hazard_data.remove();
              hazard_data.clearLayers();
            } // end function


            function createWarnings(){
              console.log("Updating Warnings...");
              var times = getWarningTimes();
              let url = '/static/forecasts/hazards/current_warnings/current_warnings_'+times[0]+'.shp';
              var exists = checkFileExists(url);
              if (exists){
                filestring2 = '/static/forecasts/hazards/current_warnings/current_warnings_'+times[0];
              } else {
                filestring2 = '/static/forecasts/hazards/current_warnings/current_warnings_'+times[1];
              }
              var warning_data = new L.Shapefile(filestring2,{
                onEachFeature:function(feature,layer){
                  let type = feature.properties.PROD_TYPE;
                  let color = warnColor(type);
                  let issuance = feature.properties.ISSUANCE.substring(0,10) + " " + feature.properties.ISSUANCE.substring(11,16) + " LT";
                  let expiration = feature.properties.EXPIRATION.substring(0,10) + " " + feature.properties.EXPIRATION.substring(11,16) + " LT";
                  let wfo = feature.properties.WFO;
                  let url = feature.properties.URL;
                  let text = `Warning Type: ${type} <br>
                              Issued by WFO: ${wfo.substring(1)} <br>
                              Start Time: ${issuance} <br>
                              End Time: ${expiration} <br>`
                  let ref = `<a href=${url}>More Info Here</a>`;
                  text = text + ref;
                  layer.bindPopup(text);
                  layer.setStyle({"color":color, "fillOpacity":"0.2"});
                  layer.bringToFront();
                  current_warnings.addLayer(layer);
                } // end forEach
              }); // end new shapefile
              warning_data.remove();
              warning_data.clearLayers();
            } // end function


            var hazardTimers = [];
            function changeHaz(map,rad){
              //var rad = document.getElementById("HazSelect").value;
              // clear layers
              current_warnings.clearLayers();
              current_hazards.clearLayers();
              convective_watches.clearLayers();
              // remove layers
              current_warnings.remove();
              current_hazards.remove();
              convective_watches.remove();

              clearTimers(hazardTimers);
              document.getElementById('warningText').innerHTML = "Warnings: Off";
              document.getElementById('hazardText').innerHTML = "Hazards: Off";

              if (rad == "NONE"){
                current_warnings.remove();
                current_hazards.remove();
                convective_watches.remove();

              }
              else if (rad === "all") {
                createHazards();
                createWarnings();
                current_hazards.addTo(map);
                convective_watches.addTo(map);
                current_warnings.addTo(map);
                // update the text information
                var valid = getWarningTimes()[0];
                var formatedTime = valid.substring(4,6)+"/"+valid.substring(6,8)+"/"+valid.substring(0,4)+" "+valid.substring(8,10)+":"+valid.substring(10,12)+":00Z";
                document.getElementById('warningText').innerHTML = "Warnings: On; Updated: "+formatedTime;
                valid = getHazardTimes()[0];
                formatedTime = valid.substring(4,6)+"/"+valid.substring(6,8)+"/"+valid.substring(0,4)+" "+valid.substring(8,10)+":"+valid.substring(10,12)+":00Z";
                document.getElementById('hazardText').innerHTML = "Hazards: On - All Hazards; Updated: "+formatedTime;
                var allTimer = setInterval(function(){
                  convective_watches.clearLayers();
                  convective_watches.remove();
                  current_hazards.clearLayers();
                  current_hazards.remove();
                  createHazards();
                  current_hazards.addTo(map);
                  convective_watches.addTo(map);
                  formatedTime = valid.substring(4,6)+"/"+valid.substring(6,8)+"/"+valid.substring(0,4)+" "+valid.substring(8,10)+":"+valid.substring(10,12)+":00Z";
                  document.getElementById('hazardText').innerHTML = "Hazards: On - All Hazards; Updated: "+formatedTime;
                },(15*60*1000)); // update every 15 minutes
                hazardTimers.push(allTimer);
                var warnTimer = setInterval(function(){
                  current_warnings.clearLayers();
                  current_warnings.remove();
                  createWarnings();
                  current_warnings.addTo(map);
                  var valid = getWarningTimes()[0];
                  var formatedTime = valid.substring(4,6)+"/"+valid.substring(6,8)+"/"+valid.substring(0,4)+" "+valid.substring(8,10)+":"+valid.substring(10,12)+":00Z";
                  document.getElementById('warningText').innerHTML = "Warnings: On; Updated: "+formatedTime;
                },(62*1000)); // update every 62 seconds
                hazardTimers.push(warnTimer);
              }

              else if (rad === "long") {
                createHazards();
                current_hazards.addTo(map);
                var valid = getHazardTimes()[0];
                var formatedTime = valid.substring(4,6)+"/"+valid.substring(6,8)+"/"+valid.substring(0,4)+" "+valid.substring(8,10)+":"+valid.substring(10,12)+":00Z";
                document.getElementById('hazardText').innerHTML = "Hazards: On - Long-Term; Updated: "+formatedTime;
                var longTimer = setInterval(function(){
                  current_hazards.clearLayers();
                  current_hazards.remove();
                  createHazards();
                  current_hazards.addTo(map);
                  var valid = getHazardTimes()[0];
                  var formatedTime = valid.substring(4,6)+"/"+valid.substring(6,8)+"/"+valid.substring(0,4)+" "+valid.substring(8,10)+":"+valid.substring(10,12)+":00Z";
                  document.getElementById('hazardText').innerHTML = "Hazards: On - Long-Term; Updated: "+formatedTime;
                },(15*60*1000)); // update every 15 minutes
                hazardTimers.push(longTimer);
              }

              else if (rad === "short") {
                createWarnings();
                current_warnings.addTo(map);
                // update the text information
                var valid = getWarningTimes()[0];
                var formatedTime = valid.substring(4,6)+"/"+valid.substring(6,8)+"/"+valid.substring(0,4)+" "+valid.substring(8,10)+":"+valid.substring(10,12)+":00Z";
                document.getElementById('warningText').innerHTML = "Warnings: On; Updated: "+formatedTime;
                // set refresh timer for warnings
                var warnTimer = setInterval(function(){
                  current_warnings.clearLayers();
                  current_warnings.remove();
                  createWarnings();
                  current_warnings.addTo(map);
                  // update the text information
                  var valid = getWarningTimes()[0];
                  var formatedTime = valid.substring(4,6)+"/"+valid.substring(6,8)+"/"+valid.substring(0,4)+" "+valid.substring(8,10)+":"+valid.substring(10,12)+":00Z";
                  document.getElementById('warningText').innerHTML = "Warnings: On; Updated: "+formatedTime;
                },(62*1000)); // update every 70 seconds
                hazardTimers.push(warnTimer);
              }

              else if (rad === "convective") {
                createHazards();
                createWarnings()
                convective_watches.addTo(map);
                current_warnings.addTo(map);
                // update the text information
                var valid = getWarningTimes()[0];
                formatedTime = valid.substring(4,6)+"/"+valid.substring(6,8)+"/"+valid.substring(0,4)+" "+valid.substring(8,10)+":"+valid.substring(10,12)+":00Z";
                document.getElementById('warningText').innerHTML = "Warnings: On; Updated: "+formatedTime;
                valid = getHazardTimes()[0];
                formatedTime = valid.substring(4,6)+"/"+valid.substring(6,8)+"/"+valid.substring(0,4)+" "+valid.substring(8,10)+":"+valid.substring(10,12)+":00Z";
                document.getElementById('hazardText').innerHTML = "Hazards: On - Watches; Updated: "+formatedTime;
                // set refresh timer for watches
                var watchTimer = setInterval(function(){
                  convective_watches.clearLayers();
                  convective_watches.remove();
                  createHazards();
                  convective_watches.addTo(map);
                  valid = getHazardTimes()[0];
                  formatedTime = valid.substring(4,6)+"/"+valid.substring(6,8)+"/"+valid.substring(0,4)+" "+valid.substring(8,10)+":"+valid.substring(10,12)+":00Z";
                  document.getElementById('hazardText').innerHTML = "Hazards: On - Watches; Updated: "+formatedTime;
                },(15*60*1000)); // update every 15 minutes
                hazardTimers.push(watchTimer);
                // set refresh timer for warnings
                var warnTimer = setInterval(function(){
                  current_warnings.clearLayers();
                  current_warnings.remove();
                  createWarnings();
                  current_warnings.addTo(map);
                  var valid = getWarningTimes()[0];
                  formatedTime = valid.substring(4,6)+"/"+valid.substring(6,8)+"/"+valid.substring(0,4)+" "+valid.substring(8,10)+":"+valid.substring(10,12)+":00Z";
                  document.getElementById('warningText').innerHTML = "Warnings: On; Updated: "+formatedTime;
                },(62*1000)); // update every 62 seconds
                hazardTimers.push(warnTimer);
              }

              else if (rad === "watch") {
                createHazards();
                convective_watches.addTo(map);
                var valid = getHazardTimes()[0];
                formatedTime = valid.substring(4,6)+"/"+valid.substring(6,8)+"/"+valid.substring(0,4)+" "+valid.substring(8,10)+":"+valid.substring(10,12)+":00Z";
                document.getElementById('hazardText').innerHTML = "Hazards: On - Watches; Updated: "+formatedTime;
                var watchTimer = setInterval(function(){
                  convective_watches.clearLayers();
                  convective_watches.remove();
                  createHazards();
                  convective_watches.addTo(map);
                  var valid = getHazardTimes()[0];
                  formatedTime = valid.substring(4,6)+"/"+valid.substring(6,8)+"/"+valid.substring(0,4)+" "+valid.substring(8,10)+":"+valid.substring(10,12)+":00Z";
                  document.getElementById('hazardText').innerHTML = "Hazards: On - Watches; Updated: "+formatedTime;
                },(15*60*1000)); // update every 15 minutes
                hazardTimers.push(watchTimer);
              }
              else {
                current_warnings.remove();
                current_hazards.remove();
                convective_watches.remove();
              }
            } // end changeHaz


  ///////////////////////////////// SURFACE OBS //////////////////////////////////////////////
            var surface_stations = new L.featureGroup();
            obsTimers = []
            function updateSFC(obsType){
              // updates the surface observations
              // get the surface obs type
              //var obsType = document.getElementById("SfcSelect").value;
              //console.log(type);
              clearTimers(obsTimers);
              if (obsType == "NONE"){ // if NONE, just remove all obs
                changeSFCtext(obsType,false);
                surface_stations.eachLayer(function(layer){
                  map.removeLayer(layer);
                });
                surface_stations.clearLayers();
              }
              else {
                changeSFCtext(obsType,true);
                // clear out the old layers and data
                surface_stations.eachLayer(function(layer){
                  map.removeLayer(layer);
                });
                surface_stations.clearLayers();
                // get new data based on zoom level
                getBulkObs(obsType);
                // plot the new data on the map
                surface_stations.addTo(map);
                // only show the obs that are in the current view.
                let zoom = map.getZoom();
                surface_stations.eachLayer(function(layer){
                  let isVisible = map.getBounds().contains(layer.getLatLng());
                  if ((isVisible) && (zoom >= 7)){
                    map.addLayer(layer);
                  }
                  else {
                    map.removeLayer(layer);
                  } // end else
                }); // end station loop

                var obsTimer = setInterval(function(){
                  // timer function to auto-update the surface obs.
                  updateSFC(obsType);
                },(300*1000));
                obsTimers.push(obsTimer);
              } // end if obsType

              //////////////// Handle obs on pan ////////////////////
              map.on('dragend', function(obsType){
                if (obsType != "NONE"){
                  let zoom = map.getZoom();
                  surface_stations.eachLayer(function(layer){
                    let isVisible = map.getBounds().contains(layer.getLatLng());
                    if ((isVisible) && (zoom >= 7)){
                      map.addLayer(layer);
                    } // end if
                    else {
                      map.removeLayer(layer);
                    } // end else
                  }); // end for each layer in surface_stations
                } // end if
                else {
                  surface_stations.eachLayer(function(layer){
                    map.removeLayer(layer);
                  });
                  surface_stations.clearLayers();
                } // end else
              }) // end map.on(pan)

              //////////////// Handle obs on zoom ////////////////////
              map.on('zoomend', function(obsType){
                if (obsType != "NONE"){
                  let zoom = map.getZoom();
                  surface_stations.eachLayer(function(layer){
                    let isVisible = map.getBounds().contains(layer.getLatLng());
                    if ((isVisible) && (zoom >= 7)){
                      map.addLayer(layer);
                    } // end if
                    else {
                      map.removeLayer(layer);
                    } // end else
                  }); // end for each layer in surface_stations
                } // end if
                else {
                  surface_stations.eachLayer(function(layer){
                    map.removeLayer(layer);
                  });
                  surface_stations.clearLayers();
                } // end else
              }) // end map.on(zoom)

            } // end updateSFC function


            function getBulkObs(type){
              // REQUEST SECTION
              var stations = {{ site_list | safe }};
              var request = new XMLHttpRequest();
              request.overrideMimeType("application/xml");
              request.open("GET","{% static '/data/metars.cache.xml' %}", false);
              //request.setRequestHeader("Content-Type","text/xml");
              request.send(null);
              var doc = request.responseXML;
              var root = doc.childNodes[0];
              var metars = root.children[6];
              for (i=0;i<metars.children.length;i++){
                var stid = metars.children[i].getElementsByTagName("station_id")[0].textContent;
                if (stations.includes(stid)){
                  try {
                    //console.log(metars.children[i].getElementsByTagName("visibility_statute_mi")[0].textContent);
                    let tc = parseFloat(metars.children[i].getElementsByTagName("temp_c")[0].textContent);
                    let tdc = parseFloat(metars.children[i].getElementsByTagName("dewpoint_c")[0].textContent);
                    let temp = C2F(tc);
                    let dewp = C2F(tdc);
                    let relh = RH(tc,tdc);
                    let wspd = parseFloat(metars.children[i].getElementsByTagName("wind_speed_kt")[0].textContent);
                    let wdir = parseFloat(metars.children[i].getElementsByTagName("wind_dir_degrees")[0].textContent);
                    let visb = parseFloat(metars.children[i].getElementsByTagName("visibility_statute_mi")[0].textContent);
                    let text = metars.children[i].getElementsByTagName("raw_text")[0].textContent;
                    let lat = parseFloat(metars.children[i].getElementsByTagName("latitude")[0].textContent);
                    let lon = parseFloat(metars.children[i].getElementsByTagName("longitude")[0].textContent);
                    var data = [lat,lon,temp,dewp,wspd,wdir,text,relh,visb];
                    //return data;
                    addStation(data,type);
                  } catch {
                    //console.log("Error parsing METAR data.");
                  } // end try/catch
                } // end if
              } // end for
            } // end function


            function createWindBarb(latitude,longitude,wspd,dir){
              var icon = L.WindBarb.icon({lat: latitude, deg: dir, speed: wspd, pointRadius: 0, strokeWidth: 2, strokeLength: 18, barbSpaceing: 4, barbHeight: 10, fillColor: 'gray'});
              var windbarb = L.marker([latitude,longitude], {icon: icon});
              windbarb.addTo(surface_stations);
            }

            function addMETARText(latitude,longitude,text,wind_color){
              var textmarker = new L.marker([latitude, longitude], { opacity: 0.0 });
              textmarker.bindTooltip(
                  `<div>
                       ${text}
                  </div>`,
                  {direction:'center', permanent: false, offset:[0,0]}
              );
              textmarker.addTo(surface_stations);
            }

            function addTempDewpPair(lat,lon,temp,dewp,temp_color,dewp_color){
              var marker = new L.marker([lat, lon], { opacity: 0.0 }); //opacity may be set to zero
              marker.bindTooltip(`<p style="color:${temp_color}; margin-bottom:0;">${temp}</p><p style="color:${dewp_color}; margin-top:0;">${dewp}</p>`, {permanent: true, className: "text-label", offset: [25,-10], direction:'center' });
              marker.addTo(surface_stations);
            }

            function addSingleValue(lat,lon,value,value_color){
              var marker = new L.marker([lat, lon], { opacity: 0.0 }); //opacity may be set to zero
              marker.bindTooltip(`<p style="color:${value_color}; margin-bottom:0;">${value}</p>`, {permanent: true, className: "text-label", offset: [10,-10], direction:'center' });
              marker.addTo(surface_stations);
            }


            // Way to add a station via JS!
            function addStation(data,type){
              if (type =="STANDARD"){
                let temp_color = "red";
                let dewp_color = "green";
                addTempDewpPair(data[0],data[1],data[2],data[3],temp_color,dewp_color);
                addMETARText(data[0],data[1],data[6]);
                createWindBarb(data[0],data[1],data[4],data[5]);
              }
              else if (type == "RLT") {
                let temp_color = tempColor(data[2]);
                let dewp_color = dewpColor(data[3]);
                addTempDewpPair(data[0],data[1],data[2],data[3],temp_color,dewp_color);
                addMETARText(data[0],data[1],data[6]);
                createWindBarb(data[0],data[1],data[4],data[5]);
              }
              else if (type == "TEMP") {
                let temp_color = tempColor(data[2]);
                addSingleValue(data[0],data[1],data[2],temp_color);
                addMETARText(data[0],data[1],data[6]);
              }
              else if (type == "DEWP") {
                let dewp_color = dewpColor(data[3]);
                addSingleValue(data[0],data[1],data[3],dewp_color);
                addMETARText(data[0],data[1],data[6]);
              }
              else if (type == "WIND") {
                createWindBarb(data[0],data[1],data[4],data[5]);
                addMETARText(data[0],data[1],data[6]);
              }
              else if (type == "FIRE") {
                let relh_color = relhColor(data[7]);
                createWindBarb(data[0],data[1],data[4],data[5]);
                addSingleValue(data[0],data[1],data[7],relh_color);
                addMETARText(data[0],data[1],data[6]);
              }
              else if (type == "VISB") {
                let visb_color = visbColor(data[8]);
                addSingleValue(data[0],data[1],data[8],visb_color);
                addMETARText(data[0],data[1],data[6]);
              }
            } // end addStation function


  ///////////////////////////////// Sat, Rad, GLM, sfc obs, Updates //////////////////////////////////////////////

            setInterval(function(){
              var currentTime = dataTimeFormat(new Date);
              var validTime = dataTimeFormat(new Date(Math.floor( new Date() / 300000) * 300000));
              console.log(currentTime,validTime);
              if (currentTime == validTime){
                times = createTimeArray(interval);
                displayGLM(times[0]);
                changeSat2(map,satType,times);
              } // end if
            },(60*1000));




///////////////////////////////// TEXT CONTROL //////////////////////////////////////////////
            // Lat lon text
            L.Control.textbox = L.Control.extend({
              onAdd: function(map) {
                var text = L.DomUtil.create('div');
                text.id = "LatLonLabel";
                text.innerHTML = "<p id='label' style='color: white; text-shadow: 1px 1px black; font-size:15px;'></p>";
                return text;
              },
              onRemove: function(map) {
                // nothing?
              }
            });
            L.control.textbox = function(opts) { return new L.Control.textbox(opts);}
            L.control.textbox({position: 'bottomright'}).addTo(map);

            // time stamp text
            L.Control.textbox = L.Control.extend({
              onAdd: function(map) {
                var text = L.DomUtil.create('div');
                text.id = "info text";
                loopstatus = "<a id='loopStatus' style='color: white; text-shadow: 1px 1px black; font-size:15px;'>Looping: Off</a><br/>";
                warningtext = "<a id='warningText' style='color: white; text-shadow: 1px 1px black; font-size:15px;'>Warnings: Off</a><br/>";
                hazardtext = "<a id='hazardText' style='color: white; text-shadow: 1px 1px black; font-size:15px;'>Hazards: Off</a><br/>";
                outlooktext = "<a id='outlookText' style='color: white; text-shadow: 1px 1px black; font-size:15px;'>Outlook: Off</a><br/>";
                sfctext = "<a id='sfctext' style='color: white; text-shadow: 1px 1px black; font-size:15px;'>Surface Obs: Off</a><br/>";
                radartime = "<a id='radarvalidtimestamp' style='color: white; text-shadow: 1px 1px black; font-size:15px;'>Radar: Off</a><br/>";
                glmtext = "<a id='glmtext' style='color: white; text-shadow: 1px 1px black; font-size:15px;'>GLM: Off</a><br/>";
                goestime = "<a id='goesvalidtimestamp' style='color: white; text-shadow: 1px 1px black; font-size:15px;'>GOES 16: Off</a><br/>";
                basetime = "<p id='timestamp' style='color: white; text-shadow: 1px 1px black; font-size:15px;'>Current Time:</p>";
                text.innerHTML = loopstatus+warningtext+hazardtext+outlooktext+sfctext+radartime+glmtext+goestime+basetime;
                return text;
              },
              onRemove: function(map) {
                // nothing?
              }
            });
            L.control.textbox = function(opts) { return new L.Control.textbox(opts);}
            L.control.textbox({position: 'bottomleft'}).addTo(map);


            function changeGOESTimestamp(show){
              if (show && satType != "none" && satType != "NONE"){
                formatedTime = times[currentIndex].substring(4,6)+"/"+times[currentIndex].substring(6,8)+"/"+times[currentIndex].substring(0,4)+" "+times[currentIndex].substring(8,10)+":"+times[currentIndex].substring(10,12)+":00Z";
                document.getElementById('goesvalidtimestamp').innerHTML = "GOES 16: "+satType.substring(3,)+" ["+(interval-currentIndex).toString()+"/"+interval.toString()+"] "+formatedTime;
              } else {
                document.getElementById('goesvalidtimestamp').innerHTML = "GOES 16: Off";
              }
            }

            function changeRadarTimestamp(show){
              if (show && radType != "none" && radType != "NONE"){
                formatedTime = times[currentIndex].substring(4,6)+"/"+times[currentIndex].substring(6,8)+"/"+times[currentIndex].substring(0,4)+" "+times[currentIndex].substring(8,10)+":"+times[currentIndex].substring(10,12)+":00Z";
                document.getElementById('radarvalidtimestamp').innerHTML = "Radar: "+radType+" ["+(interval-currentIndex).toString()+"/"+interval.toString()+"] "+formatedTime;
              } else {
                document.getElementById('radarvalidtimestamp').innerHTML = "Radar: Off";
              }
            }

            function changeGLMTimestamp(show){
              if (show){
                formatedTime = times[currentIndex].substring(4,6)+"/"+times[currentIndex].substring(6,8)+"/"+times[currentIndex].substring(0,4)+" "+times[currentIndex].substring(8,10)+":"+times[currentIndex].substring(10,12)+":00Z";
                //document.getElementById('glmtext').innerHTML = "GLM: Flash Events ["+(interval-currentIndex).toString()+"/"+interval.toString()+"] "+formatedTime;
                document.getElementById('glmtext').innerHTML = "GLM: Flash Events - Updated: "+formatedTime;

              } else {
                document.getElementById('glmtext').innerHTML = "GLM: Off";
              }
            }

            function changeLoopStatus(play){
              if (play){
                document.getElementById('loopStatus').innerHTML = "Looping: On";
              } else {
                document.getElementById('loopStatus').innerHTML = "Looping: Off";
              }
            }

            function changeSFCtext(type,show){
              if (show) {
                formatedTime = times[0].substring(4,6)+"/"+times[currentIndex].substring(6,8)+"/"+times[0].substring(0,4)+" "+times[0].substring(8,10)+":"+times[0].substring(10,12)+":00Z";
                document.getElementById('sfctext').innerHTML = "Surface Obs: "+type+"; Updated: "+formatedTime;
              } else {
                document.getElementById('sfctext').innerHTML = "Surface Obs: Off";
              }  // end if/else
            }

            function changeOUTtext(type,show){
              if (show) {
                var time = dataTimeFormat(new Date(Math.floor( new Date() / (1800*1000)) * (1800*1000)));
                formatedTime = time.substring(4,6)+"/"+time.substring(6,8)+"/"+time.substring(0,4)+" "+time.substring(8,10)+":"+time.substring(10,12)+":00Z";
                document.getElementById('outlookText').innerHTML = "Outlook: "+type+"; Updated: "+formatedTime;
              } else {
                document.getElementById('outlookText').innerHTML = "Outlook: Off";
              }  // end if/else
            }

///////////////////////////////// MAP VIEW //////////////////////////////////////////////
            function changeMapView(map,newView){
              // changes the map view based on menu selection
              //var newView = document.getElementById("MapView").value;
              console.log(newView);

              if (newView === "CONUS"){
                var center = L.latLng(40.0, -100.0);
                var zoom = 5;
                map.setView(center,zoom);
              }
              else if (newView == "NORTHAM") {
                var center = L.latLng(48.0, -101.0);
                var zoom = 4;
                map.setView(center,zoom);
              }
              else if (newView == "WORLD") {
                var center = L.latLng(35.0, -18.0);
                var zoom = 2;
                map.setView(center,zoom);
              }
              else if (newView == "NW") {
                var center = L.latLng(45.0, -117.0);
                var zoom = 7;
                map.setView(center,zoom);
              }
              else if (newView == "SW") {
                var center = L.latLng(36.0, -115.0);
                var zoom = 7;
                map.setView(center,zoom);
              }
              else if (newView == "SP") {
                var center = L.latLng(35.0, -97.0);
                var zoom = 7;
                map.setView(center,zoom);
              }
              else if (newView == "SE") {
                var center = L.latLng(32.0, -85.0);
                var zoom = 7;
                map.setView(center,zoom);
              }
              else if (newView == "NE") {
                var center = L.latLng(41.0, -76.0);
                var zoom = 7;
                map.setView(center,zoom);
              }
              else if (newView == "MW") {
                var center = L.latLng(41.0, -87.0);
                var zoom = 7;
                map.setView(center,zoom);
              }
              else if (newView == "CP") {
                var center = L.latLng(40.0, -98.0);
                var zoom = 7;
                map.setView(center,zoom);
              }
              else if (newView == "NP") {
                var center = L.latLng(47.0, -100.0);
                var zoom = 7;
                map.setView(center,zoom);
              }
              else if (newView == "CR") {
                var center = L.latLng(41.0, -108.0);
                var zoom = 7;
                map.setView(center,zoom);
              }
            }

///////////////////////////////// Time/Loop control //////////////////////////////////////////////
            var play = false;
            var loops = [];
            document.addEventListener("keydown", (event) => {

                if (event.keyCode == 37){
                  play = false;
                  changeLoopStatus(play);
                  try{
                    clearTimers(loops);
                  } catch {
                    console.log("No timers yet");
                  }
                  globalThis.previousIndex = currentIndex;
                  globalThis.currentIndex = currentIndex + 1;
                  if (currentIndex == times.length){
                     globalThis.currentIndex = 0;
                  } // end if
                  displaySat(true);
                  displayRadar(true);
                  //displayGLM(showGLM);
                } // end if

                else if (event.keyCode == 39) {
                  play = false;
                  changeLoopStatus(play);
                  try{
                    clearTimers(loops);
                  } catch {
                    console.log("No timers yet");
                  }
                  globalThis.previousIndex = currentIndex;
                  globalThis.currentIndex = currentIndex - 1;
                  if (currentIndex < 0){
                    globalThis.currentIndex = times.length-1;
                  } // end if
                  displaySat(true);
                  displayRadar(true);
                  //displayGLM(showGLM);
                } // end else if

                else if (event.keyCode == 32) {
                  //console.log("Space Bar was hit!");
                  play = !play;
                  //console.log(play);
                  changeLoopStatus(play);
                  if (play) {
                    var loop = setInterval(function() {
                      globalThis.previousIndex = currentIndex;
                      globalThis.currentIndex = currentIndex - 1;
                      if (currentIndex < 0){
                        globalThis.currentIndex = times.length-1;
                      } // end if
                      displaySat(true);
                      displayRadar(true);
                      //displayGLM(showGLM);
                    }, (500));
                    loops.push(loop);
                  }
                  else {
                    clearTimers(loops);
                  } // end else
                } // end else if
            }); // end event listener

///////////////////////////////// Sat, Rad, GLM, sfc obs, Updates //////////////////////////////////////////////

            setInterval(function(){
              oldTime = times[0];
              globalThis.times = createTimeArray(interval);
              globalThis.currentIndex = 0;
              if (oldTime != times[0]){
                if (radType != "NONE" && radType != 'none'){
                  for(i=0;i<rad_imgs.length;i++){
                    map.removeLayer(rad_imgs[i]);
                  }
                  loadRadar(radType,times,radOpac);
                }
                if (satType != "NONE" && satType != "none"){
                  for(i=0;i<sat_imgs.length;i++){
                    map.removeLayer(sat_imgs[i]);
                  }
                  loadSat(satType,times,satOpac);
                }
                // if (showGLM){
                //   loadGLM(times);
                //   displayGLM(showGLM);
                // }
              }// end if oldTime

            },(60*1000));

            setInterval(function(){
              clockAndLabel();
            },1000);
///////////////////////////////////////////////////////////////////////////////

</script>

{% endblock %}
