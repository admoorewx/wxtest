<!DOCTYPE html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>Wx Map</title>
        <script>
            L_NO_TOUCH = false;
            L_DISABLE_3D = false;
        </script>

    <style>html, body {width: 100%;height: 100%;margin: 0;padding: 0;}</style>
    <style>#map {position:absolute;top:0;bottom:0;right:0;left:0;}</style>
    <script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.6.0/dist/leaflet.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.js"></script>
    <script src="https://cdn.flexmonster.com/flexmonster.js"></script>
    <!-- Link to example I'm following: https://jsfiddle.net/flexmonster/vnc2h7s8/ -->
    {% load static %}
    <script type="text/javascript" src="{% static '/javascript/Leaflet.windbarb-master/src/leaflet-windbarb.js' %}"></script>
    <script type="text/javascript" src="{% static '/javascript/leaflet.shapefile/leaflet.shpfile.js' %}"></script>
    <script type="text/javascript" src="{% static '/javascript/dom-to-image-master/src/dom-to-image.js' %}"></script>
    <script type="text/javascript" src="{% static '/javascript/shapefile-js/dist/shp.js' %}"></script>
    <script type="text/javascript" src="{% static '/javascript/jscolor/jscolor.js' %}"></script>
    <script type="text/javascript" src="{% static '/javascript/mapping_functions.js' %}"></script>



    <script src="{% static '/javascript/Leaflet.Draw/src/Leaflet.draw.js' %}"></script>
    <script src="{% static '/javascript/Leaflet.Draw/src/Leaflet.Draw.Event.js' %}"></script>
    <link rel="stylesheet" href="{% static '/javascript/Leaflet.Draw/src/leaflet.draw.css' %}"/>


    <script src="{% static '/javascript/Leaflet.Draw/src/Toolbar.js' %}"></script>
    <script src="{% static '/javascript/Leaflet.Draw/src/Tooltip.js' %}"></script>

    <script src="{% static '/javascript/Leaflet.Draw/src/ext/GeometryUtil.js' %}"></script>
    <script src="{% static '/javascript/Leaflet.Draw/src/ext/LatLngUtil.js' %}"></script>
    <script src="{% static '/javascript/Leaflet.Draw/src/ext/LineUtil.Intersect.js' %}"></script>
    <script src="{% static '/javascript/Leaflet.Draw/src/ext/Polygon.Intersect.js' %}"></script>
    <script src="{% static '/javascript/Leaflet.Draw/src/ext/Polyline.Intersect.js' %}"></script>
    <script src="{% static '/javascript/Leaflet.Draw/src/ext/TouchEvents.js' %}"></script>

    <script src="{% static '/javascript/Leaflet.Draw/src/draw/DrawToolbar.js' %}"></script>
    <script src="{% static '/javascript/Leaflet.Draw/src/draw/handler/Draw.Feature.js' %}"></script>
    <script src="{% static '/javascript/Leaflet.Draw/src/draw/handler/Draw.SimpleShape.js' %}"></script>
    <script src="{% static '/javascript/Leaflet.Draw/src/draw/handler/Draw.Polyline.js' %}"></script>
    <script src="{% static '/javascript/Leaflet.Draw/src/draw/handler/Draw.Marker.js' %}"></script>
    <script src="{% static '/javascript/Leaflet.Draw/src/draw/handler/Draw.Circle.js' %}"></script>
    <script src="{% static '/javascript/Leaflet.Draw/src/draw/handler/Draw.CircleMarker.js' %}"></script>
    <script src="{% static '/javascript/Leaflet.Draw/src/draw/handler/Draw.Polygon.js' %}"></script>
    <script src="{% static '/javascript/Leaflet.Draw/src/draw/handler/Draw.Rectangle.js' %}"></script>


    <script src="{% static '/javascript/Leaflet.Draw/src/edit/EditToolbar.js' %}"></script>
    <script src="{% static '/javascript/Leaflet.Draw/src/edit/handler/EditToolbar.Edit.js' %}"></script>
    <script src="{% static '/javascript/Leaflet.Draw/src/edit/handler/EditToolbar.Delete.js' %}"></script>

    <script src="{% static '/javascript/Leaflet.Draw/src/Control.Draw.js' %}"></script>

    <script src="{% static '/javascript/Leaflet.Draw/src/edit/handler/Edit.Poly.js' %}"></script>
    <script src="{% static '/javascript/Leaflet.Draw/src/edit/handler/Edit.SimpleShape.js' %}"></script>
    <script src="{% static '/javascript/Leaflet.Draw/src/edit/handler/Edit.Rectangle.js' %}"></script>
    <script src="{% static '/javascript/Leaflet.Draw/src/edit/handler/Edit.Marker.js' %}"></script>
    <script src="{% static '/javascript/Leaflet.Draw/src/edit/handler/Edit.CircleMarker.js' %}"></script>
    <script src="{% static '/javascript/Leaflet.Draw/src/edit/handler/Edit.Circle.js' %}"></script>




    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.6.0/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap-theme.min.css"/>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/python-visualization/folium/folium/templates/leaflet.awesome.rotate.min.css"/>

    <meta name="viewport" content="width=device-width,
        initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <style>

        #colorPicker{
          position: relative;
          z-index: 10;
          height: 33px;
          width: 33px;
          left: -67px;
        }

        /* Chrome version 29 and above */
        @media screen and (-webkit-min-device-pixel-ratio:0)
        and (min-resolution:.001dpcm) {
          #colorPicker{ top:30vh; }
        }
        /* for firefox */
        @-moz-document url-prefix() {
          #colorPicker {
            top: 38vh;
          }
        }

        #screenshot{
          background: url({% static '/media/icons/camera.png' %}) no-repeat top;
          background-color: rgba(80,78,78,0.9);
          background-size: 80.0% 90.0%;
          position: relative;
          z-index: 10;
          height: 33px;
          width: 33px;
          left: -104px;
          top: 335px;
        }

        #container {
          position: absolute;
          height: 100.0%;
          width: 100.0%;
          top: 0px;
          z-index: 0;
        }
        #map_holder {
            position: absolute;
            width: 100.0vw;
            height: 100.0%;
            left: 0.0%;
            top: 0.0vh;
        }
        #layerOps {
          position: absolute;
          width: 10.0vw;
          height: 48.0vh;
          left: 0.0%;
          top: 4.0vh;
          background-color:red;
        }
        #actLayers {
          position: absolute;
          width: 10.0vw;
          height: 48.0vh;
          left: 0.0%;
          top: 50.0vh;
          background-color:blue;
        }
        #toolbar {
          display: none;
          z-index: 10;
          position: absolute;
          width: 40vw;
          height: 50px;
          left: 30.0vw;
          top: 12px;
          background-color:rgba(80,78,78,0.9);
          text-align: center;
          border-color: black;
          border-width: 2px;
          border-style: solid;
          min-width: 500px;
          overflow: hidden;
        }

        .glm_strike {
            position: absolute;
            width:0px;
            height:0px;
            color: White;
            background-color: rgba(0,0,0,0.0);
            border-color: rgba(0,0,0,0.0);
            border: 0px;
            font-size:10px;
            font-weight: bold;
            text-shadow: 1px 1px 2px Black;
            box-shadow: none;
        }

        #MapView {
          text-align: center;
        }
        #RadarSelect {
          text-align: center;
        }
        #SatSelect {
          text-align: center;
        }
        #HazSelect {
          text-align: center;
        }
        #SfcSelect {
          text-align: center;
        }
        .spc_box{
          top: 10px;
        }
        .fire_box{
          top: 30px;
        }
        .text-label {
            position: absolute;
            width:0px;
            height:0px;
            background-color: rgba(0,0,0,0.0);
            border-color: rgba(0,0,0,0.0);
            border: 0px;
            font-size:12px;
            font-weight: bold;
            text-shadow: 0 0 4px Black;
            box-shadow: none;
        }
        .leaflet-tooltip-top:before,
        .leaflet-tooltip-bottom:before,
        .leaflet-tooltip-left:before,
        .leaflet-tooltip-right:before {
          background-color: rgba(0,0,0,0.0);
          border:none;
          box-shadow:none;
        }
        .popup{
          max-width: 175px;
        }

        #menu_button{
          position: relative;
          z-index: 10;
          left:50px;
          top:12px;
          height:50px;
          width: 75px;
          color: white;
          background-color: rgba(80,78,78,0.9);
        }

        .menu_option{
          height: 100.0%;
          width: 100.0%;
          border-color: black;
          border-width: 0px;
          border-style: solid;
        }

        /* ---- Map Button ---- */
        #mapmenu{
          display: inline-block;
          position: absolute;
          height: 100.0%;
          width: 10.0%;
          left: 6.0%;
        }
        #map_button{
          background: url({% static '/media/icons/worldwide.png' %}) no-repeat top;
          background-color: transparent;
          background-size: 100.0% 100.0%;
        }

        .mapcontent{
          position: fixed;
          display: none;
          z-index: 11;
          width:200px;
          height:150px;
        }

        .mapcontent a {
          color: white;
          display: block;
          background-color: rgba(80,78,78,0.9);
          cursor: pointer;
        }

        .mapcontent a:hover {background-color: gray;}
        #mapmenu:hover .mapcontent {display: block;}
        #mapmenu:hover #map_button {background-color: rgba(56,82,142,1.0); border-width: 1px;}

        /* ---- Satellite Button ---- */
        #satmenu{
          display: inline-block;
          position: absolute;
          height: 100.0%;
          width: 10.0%;
          left: 19.0%;
        }
        #sat_button{
          background: url({% static '/media/icons/satellite.png' %}) no-repeat top;
          background-color: transparent;
          background-size: 100.0% 100.0%;
        }

        .satcontent{
          position: fixed;
          display: none;
          z-index: 11;
          width:200px;
          height:150px;
        }

        .satcontent a {
          color: white;
          display: block;
          width: 300px;
          background-color: rgba(80,78,78,0.9);
          cursor: pointer;
        }

        .satcontent a:hover {background-color: gray;}
        #satmenu:hover .satcontent {display: block;}
        #satmenu:hover #sat_button {background-color: rgba(56,82,142,1.0); border-width: 1px;}


        /* ---- GLM Button ---- */
        #glmmenu{
          display: inline-block;
          position: absolute;
          height: 100.0%;
          width: 10.0%;
          left: 32.0%;
        }
        #glm_button{
          background: url({% static '/media/icons/flash.png' %}) no-repeat top;
          background-color: transparent;
          background-size: 98.0% 98.0%;
        }

        .glmcontent{
          position: fixed;
          display: none;
          z-index: 11;
          width:200px;
          height:150px;
        }

        .glmcontent a {
          color: white;
          display: block;
          background-color: rgba(80,78,78,0.9);
          cursor: pointer;
        }

        .glmcontent a:hover {background-color: gray;}
        #glmmenu:hover .glmcontent {display: block;}
        #glmmenu:hover #glm_button {background-color: rgba(56,82,142,1.0); border-width: 1px;}



        /* ---- Radar Button ---- */
        #radmenu{
          display: inline-block;
          position: absolute;
          height: 100.0%;
          width: 10.0%;
          left: 45.0%;
        }
        #rad_button{
          background: url({% static '/media/icons/radar2.png' %}) no-repeat top;
          background-color: transparent;
          background-size: 100.0% 100.0%;
        }

        .radcontent{
          position: fixed;
          display: none;
          z-index: 11;
          width:200px;
          height:150px;
        }

        .radcontent a {
          color: white;
          display: block;
          background-color: rgba(80,78,78,0.9);
          cursor: pointer;
        }

        .radcontent a:hover {background-color: gray;}
        #radmenu:hover .radcontent {display: block;}
        #radmenu:hover #rad_button {background-color: rgba(56,82,142,1.0); border-width: 1px;}


        /* ---- Hazard Button ---- */
        #hazmenu{
          display: inline-block;
          position: absolute;
          height: 100.0%;
          width: 10.0%;
          left: 58.0%;
        }
        #haz_button{
          background: url({% static '/media/icons/warning.png' %}) no-repeat top;
          background-color: transparent;
          background-size: 100.0% 100.0%;
        }

        .hazcontent{
          position: fixed;
          display: none;
          z-index: 11;
          width:200px;
          height:150px;
        }

        .hazcontent a {
          color: white;
          display: block;
          background-color: rgba(80,78,78,0.9);
          cursor: pointer;
        }

        .hazcontent a:hover {background-color: gray;}
        #hazmenu:hover .hazcontent {display: block;}
        #hazmenu:hover #haz_button {background-color: rgba(56,82,142,1.0); border-width: 1px;}

        /* ---- Surface Button ---- */
        #sfcmenu{
          display: inline-block;
          position: absolute;
          height: 100.0%;
          width: 10.0%;
          left: 71.0%;
        }
        #sfc_button{
          background: url({% static '/media/icons/windsock.png' %}) no-repeat top;
          background-color: transparent;
          background-size: 100.0% 100.0%;
        }

        .sfccontent{
          position: fixed;
          display: none;
          z-index: 11;
          width:200px;
          height:150px;
        }

        .sfccontent a {
          color: white;
          display: block;
          background-color: rgba(80,78,78,0.9);
          cursor: pointer;
        }

        .sfccontent a:hover {background-color: gray;}
        #sfcmenu:hover .sfccontent {display: block;}
        #sfcmenu:hover #sfc_button {background-color: rgba(56,82,142,1.0); border-width: 1px;}

        /* ---- Outlook Button ---- */
        #outmenu{
          display: inline-block;
          position: absolute;
          height: 100.0%;
          width: 10.0%;
          left: 84.0%;
        }
        #out_button{
          background: url({% static '/media/icons/storm.png' %}) no-repeat top;
          background-color: transparent;
          background-size: 100.0% 100.0%;
        }

        .outcontent{
          position: fixed;
          display: none;
          z-index: 11;
          width:200px;
          height:150px;
        }

        .outcontent a {
          color: white;
          display: block;
          background-color: rgba(80,78,78,0.9);
          cursor: pointer;
        }

        .outcontent a:hover {background-color: gray;}
        #outmenu:hover .outcontent {display: block;}
        #outmenu:hover #out_button {background-color: rgba(56,82,142,1.0); border-width: 1px;}

        #selection {
            position: absolute;
            z-index: 10;
            background: #e0eaf1;
            border: 1px solid #0c65a5;
        }

        #selection.complete {
            background: #E0F1E4;
            border-color: #0CA50E;
        }

        #contextMenu{
          position: fixed;
          z-index: 100;
          width: 220px;
          color: "white";
          border-radius: 3px;
          background: rgba(80,78,78,0.9);
          border-color: "black";
          display: none;
        }
        #contextMenu .item{
          padding: 8px 10px;
          font-size: 15px;
          color: "white";
          cursor: pointer;
          border-radius: inherit;
        }
        #contextMenu .item:hover{
          background: #343434;
        }
        #contextMenu.visible{
          cursor: pointer;
          display: block;
        }

        #metarDataHolder{
          position: fixed;
          z-index: 100;
          width: 215px;
          height: 250px;
          top: 65vh;
          left: 8px;
          border-radius: 15px;
          display: none;
        }
        #metarDataHolder.visible{
          display: block;
        }

        #metardata{
          height: 100%;
          width: 94%;
          padding-left: 3%;
          color: white;
          border-width: 3px;
          border-color: black;
          background: rgba(0,0,0,0.7);
          border-radius: 15px;
        }

    </style>

</head>
<body>
{% block content %}
  <button id="menu_button" onclick="showToolbar()">Data Menu</button>

  <div class="toolBar" id="toolbar">

    <div id="mapmenu">
      <button type="button" class="menu_option" id="map_button"></button>
      <div class="mapcontent">
        <a onclick="changeMapView(map,'WORLD')">World</a>
        <a onclick="changeMapView(map,'NORTHAM')">North America</a>
        <a onclick="changeMapView(map,'CONUS')">CONUS</a>
        <a onclick="changeMapView(map,'NW')">Northwest</a>
        <a onclick="changeMapView(map,'NP')">Northern Plains</a>
        <a onclick="changeMapView(map,'NE')">Northeast</a>
        <a onclick="changeMapView(map,'CP')">Central Plains</a>
        <a onclick="changeMapView(map,'CR')">Central Rockies</a>
        <a onclick="changeMapView(map,'SW')">Southwest</a>
        <a onclick="changeMapView(map,'SP')">Southern Plains</a>
        <a onclick="changeMapView(map,'SE')">Southeast</a>
        <a onclick="changeMapView(map,'MW')">Midwest</a>

      </div>
    </div>

    <div id="satmenu">
      <button type="button" class="menu_option" id="sat_button"></button>
      <div class="satcontent">
        <a onclick="changeSat(map,'NONE')">NONE</a>
        <a>------- CONUS (non-looping) -------</a>
        <a onclick="changeSat(map,'G16ch2')">GOES-16 CONUS Ch. 2 Visible</a>
        <!-- <a onclick="changeSat(map,'G16ch3')">GOES-16 CONUS Ch. 3 Near-IR</a> -->
        <a onclick="changeSat(map,'G16ch5')">GOES-16 CONUS Ch. 5 Snow/Ice</a>
        <!-- <a onclick="changeSat(map,'G16ch7')">GOES-16 CONUS Ch. 7 Shortwave IR</a> -->
        <a onclick="changeSat(map,'G16ch8')">GOES-16 CONUS Ch. 8 Upper-Level W.V.</a>
        <a onclick="changeSat(map,'G16ch9')">GOES-16 CONUS Ch. 9 Mid-Level W.V.</a>
        <a onclick="changeSat(map,'G16ch10')">GOES-16 CONUS Ch. 10 Low-Level W.V.</a>
        <a onclick="changeSat(map,'G16ch13')">GOES-16 CONUS Ch. 13 Clean IR</a>
        <a onclick="changeSat(map,'G16IRsand')">GOES-16 CONUS Vis/IR Sandwich</a>
        <a>------- MESO 1 (non-looping) -------</a>
        <a onclick="changeSat(map,'G16ch2m1')">GOES-16 MESO 1 Ch. 2 Visible</a>
        <a onclick="changeSat(map,'G16ch5m1')">GOES-16 MESO 1 Ch. 5 Snow/Ice</a>
        <a onclick="changeSat(map,'G16ch8m1')">GOES-16 MESO 1 Ch. 8 Upper-Level W.V.</a>
        <a onclick="changeSat(map,'G16ch9m1')">GOES-16 MESO 1 Ch. 9 Mid-Level W.V.</a>
        <a onclick="changeSat(map,'G16ch10m1')">GOES-16 MESO 1 Ch. 10 Low-Level W.V.</a>
        <a onclick="changeSat(map,'G16ch13m1')">GOES-16 MESO 1 Ch. 13 IR</a>
        <a onclick="changeSat(map,'G16IRsandm1')">GOES-16 MESO 1 Vis/IR Sandwich</a>
        <a>------- MESO 2 (non-looping) -------</a>
        <a onclick="changeSat(map,'G16ch2m2')">GOES-16 MESO 2 Ch. 2 Visible</a>
        <a onclick="changeSat(map,'G16ch5m2')">GOES-16 MESO 2 Ch. 5 Snow/Ice</a>
        <a onclick="changeSat(map,'G16ch8m2')">GOES-16 MESO 2 Ch. 8 Upper-Level W.V.</a>
        <a onclick="changeSat(map,'G16ch9m2')">GOES-16 MESO 2 Ch. 9 Mid-Level W.V.</a>
        <a onclick="changeSat(map,'G16ch10m2')">GOES-16 MESO 2 Ch. 10 Low-Level W.V.</a>
        <a onclick="changeSat(map,'G16ch13m2')">GOES-16 MESO 2 Ch. 13 IR</a>
        <a onclick="changeSat(map,'G16IRsandm2')">GOES-16 MESO 2 Vis/IR Sandwich</a>
      </div>
    </div>

    <div id="glmmenu">
      <button type="button" class="menu_option" id="glm_button"></button>
      <div class="glmcontent">
        <a onclick="showGLM(map,false)">None</a>
        <a onclick="showGLM(map,true)">GLM Flash Events (last 5 min)</a>
      </div>
    </div>

    <div id="radmenu">
      <button type="button" class="menu_option" id="rad_button"></button>
      <div class="radcontent">
        <a onclick="changeRadar(map,'NONE')">NONE</a>
        <a onclick="changeRadar(map,'MRMS')">MRMS Composite Reflectivity</a>
        <a onclick="changeRadar(map,'conus_base_refl')">IEM Base Reflectivity</a>
      </div>
    </div>

    <div id="sfcmenu">
      <button type="button" class="menu_option" id="sfc_button"></button>
      <div class="sfccontent">
        <a onclick="updateSFC('NONE')">NONE</a>
        <a onclick="updateSFC('black')">Black</a>
        <a onclick="updateSFC('white')">White</a>
        <a onclick="updateSFC('standard')">Standard</a>
        <a onclick="updateSFC('RLT')">Color Coded</a>
        <a onclick="updateSFC('TEMP')">Temperature</a>
        <a onclick="updateSFC('DEWP')">Dewpoint</a>
        <a onclick="updateSFC('WIND')">Winds</a>
        <a onclick="updateSFC('MSLP')">MSLP</a>
        <a onclick="updateSFC('FIRE')">RH + Winds</a>
        <a onclick="updateSFC('VISB')">Visibility</a>
        <a onclick="updateSFC('AVIATION')">Flight Categories</a>
      </div>
    </div>

    <div id="hazmenu">
      <button type="button" class="menu_option" id="haz_button"></button>
      <div class="hazcontent">
        <a onclick="changeHaz(map,'NONE')">NONE</a>
        <a onclick="changeHaz(map,'all')">All Hazards</a>
        <a onclick="changeHaz(map,'long')">Long-Duration Hazards</a>
        <a onclick="changeHaz(map,'short')">Convective Warnings</a>
        <a onclick="changeHaz(map,'watch')">Convective Watches</a>
        <a onclick="changeHaz(map,'convective')">Convective Watch/Warnings</a>
      </div>
    </div>

    <div id="outmenu">
      <button type="button" class="menu_option" id="out_button"></button>
      <div class="outcontent">
        <a onclick="changeOut(map,'NONE')">NONE</a>
        <a onclick="changeOut(map,'spcd1cat')">SPC Day 1 Categorical</a>
        <a onclick="changeOut(map,'spcd1fire')">SPC Day 1 Fire</a>
      </div>
    </div>

  </div>

  <button id="colorPicker" data-jscolor="{onInput:'changeColor(this)', preset:'dark',value:'rgba(38,59,246,1.0)'}"></button>
  <button id="screenshot" onclick="takeScreenshot()"></button>

  <div id="container">
    <div class="folium-map" id="map_holder"></div>
  </div>

  <div id="contextMenu">
    <button id="showmetar" style="width:100%" onclick="changeMetarDisplay()">Display sfc data on hover: OFF</button>
  </div>

  <div id="metarDataHolder">
    <p id="metardata">p</p>
  </div>

</body>
<script>

///////////////////////////////// Sat, Rad, GLM, sfc obs, Time settings //////////////////////////////////////////////
  var update = 10; // seconds
  var interval = 10; // number of frames
  var times = createTimeArray(interval); // create list of times
  // this is the initial creation. The update timer is at the end of the script
  globalThis.satType = ''; // initialize the satellite type
  var metarDisplay = false;
  var obsType = "NONE";
/////////////////////////////////////////// Show metar data display ////////////////////////////////////////////////
  const contextMenu = document.getElementById("contextMenu");
  const scope = document.querySelector("#container");
  scope.addEventListener("contextmenu", (event) => {
    event.preventDefault();
    const { clientX: mouseX, clientY: mouseY } = event;
    contextMenu.style.top = `${mouseY}px`;
    contextMenu.style.left = `${mouseX}px`;
    contextMenu.classList.add("visible");
  });
  scope.addEventListener("click",(e) => {
    if (e.target.offsetParent != contextMenu){
      contextMenu.classList.remove("visible");
    }
  });
///////////////////////////////// Handles hiding/showing the toolbar //////////////////////////////////////////////
  var showMenu = false;
  function showToolbar() {
    if (!showMenu){
      $('#menu_button').text("Hide Menu");
      showMenu = true;
      $('#toolbar').css({display: "block"});
      $('#menu_button').css({"background-color": "rgba(56,82,142,1.0)", color: "white"});
    } else {
      $('#menu_button').text("Show Menu");
      $('#menu_button').css({"background-color": "rgba(80,78,78,0.9)", color: "white"});
      showMenu = false;
      $('#toolbar').css({display: "none"});
    } // end else
  } // end showToolbar function
///////////////////////////////// Handles centering the toolbar //////////////////////////////////////////////
  window.addEventListener('resize', function(){
    var width = window.innerWidth;
    var tbwidth = width * 0.4;
    var left = width * 0.3;
    $('#toolbar').css({width: `"${tbwidth}"`, left: `"${left}"`});
  });
////////////////////////////////// SCREENSHOT //////////////////////////////////////////////////////////
  function takeScreenshot(){
    window.alert("Generating Image...\nThis may take several seconds depending on data load.");
    var screenheight = window.innerHeight;
    var screenwidth = window.innerWidth;
    var top = 55;
    var bottom = screenheight - top;
    var left = 55;
    var right = screenwidth - left;

    var imagestyle = {
      clip: `rect(${top}px,${right}px,${bottom}px,${left}px)`,
      backgroundColor: "rgba(255,255,255,1.0)",
    }

    domtoimage.toJpeg(document.getElementById("map_holder"), { quality: 1.0, height:screenheight, width:screenwidth,bgcolor: "rgba(255,255,255,1.0)", style: imagestyle})
      .then(function(dataurl){
        var link = document.createElement('a');
        link.download = 'screenshot.jpeg';
        link.href = dataurl;
        link.click();
      });
  }
///////////////////////////////////////// GLM  //////////////////////////////////////////////
  var glm_strikes = L.featureGroup();
  function displayGLM(){
    console.log("Updating GLM.");
    var glm_file = "{% static '/data/glm/GLM_latest.json' %}";
    glm_strikes.clearLayers();
    $.ajax({
    dataType: "json",
    url: glm_file,
    success: function(data) {
        $.each(data, function(key,info){
          let lat = info.Lat;
          let lon = info.Lon;
          var marker = new L.circleMarker([lat, lon], { radius: 3, color: "black", weight: 1, opacity: 1.0, fillColor: "yellow", fillOpacity: 0.65 }); //opacity may be set to zero
          marker.addTo(glm_strikes);
        });
    }
    }).error(function() {
      console.log("Error updating GLM data.");
    });
  }
  displayGLM();

  function showGLM(map,show){
    if (show){
      console.log("Showing GLM");
      glm_strikes.addTo(map);
    } else {
      console.log("Hiding GLM");
      glm_strikes.remove();
    }
  } // end function showGLM
///////////////////////////////// MOUSE LAT/LON //////////////////////////////////////////////
  L.CursorHandler = L.Handler.extend({
      addHooks: function () {
          this._map.on('mousemove', this._update, this);
      },
      _update: function (e) {
        document.getElementById('latlonlabel').innerHTML = e.latlng.lat.toFixed(4).toString()+", "+e.latlng.lng.toFixed(4).toString();
      }
  });
  L.Map.addInitHook('addHandler', 'cursor', L.CursorHandler);
///////////////////////////////// MAP DEFINITION //////////////////////////////////////////////
  var map = L.map(
      "map_holder",
      {
          center: [40.0, -100.0],
          crs: L.CRS.EPSG3857,
          zoom: 5,
          attributionControl: true,
          zoomControl: false,
          cursor: true,
          preferCanvas: true,
          renderer: L.canvas(),
          keyboard: false,
          updateWhenIdle: true,
          updateWhenZooming: false,
      }
  );
///////////////////////////////// BOUNDARY CONTROL //////////////////////////////////////////////
  var county_style = {
      "color":"#F7F3F3",
      "fillColor":"none",
      "fillOpacity":0.0,
      "opacity":0.4,
      "weight": 0.5,
  }
  var state_style = {
      "color":"#F7F3F3",
      "fillColor":"none",
      "fillOpacity":0.0,
      "opacity":0.9,
      "weight": 0.9,
  }

  var cwa_style = {
      "color":"#FFDB49",
      "fillColor":"none",
      "fillOpacity":0.0,
      "opacity":0.9,
      "weight": 1.0,
  }

  var glm_style = {
      "color":"black",
      "fillColor":"yellow",
      "fillOpacity":1.0,
      "opacity":0.9,
      "weight": 1.0,
  }

  var district_boundary = new L.geoJson();
  $.ajax({
  dataType: "json",
  url: "{% static '/geo/boundaries/uscounties.json' %}",
  success: function(data) {
      $(data.features).each(function(key, data) {
          district_boundary.addData(data).setStyle(county_style);
          //district_boundary.setStyle(county_style);
      });
  }
  }).error(function() {});

  var state_boundary = new L.geoJson();
  state_boundary.addTo(map);
  $.ajax({
  dataType: "json",
  url: "{% static '/geo/boundaries/usstates.json' %}",
  success: function(data) {
      $(data.features).each(function(key, data) {
          state_boundary.addData(data);
          state_boundary.setStyle(state_style);
      });
  }
  }).error(function() {});


  var cwa_boundary = new L.geoJson();
  $.ajax({
  dataType: "json",
  url: "{% static '/geo/boundaries/cwa/cwa.geojson' %}",
  success: function(data) {
      $(data.features).each(function(key, data) {
          cwa_boundary.addData(data);
          cwa_boundary.setStyle(cwa_style);
      });
  }
  }).error(function() {});
///////////////////////////////// LAYER CONTROL //////////////////////////////////////////////
  attrib = "Data sources: \u003ca href=\"http://openstreetmap.org\"\u003eOpenStreetMap\u003c/a\u003e, \u003ca href=\"http://mesonet.agron.iastate.edu/GIS/\"\u003eIEM\u003c/a\u003e, \u003ca href=\"https://www.noaa.gov/\"\u003eNOAA\u003c/a\u003e, \u003ca href=\"https://www.spc.noaa.gov/\"\u003eSPC\u003c/a\u003e, \u003ca href=\"https://www.aviationweather.gov/metar\"\u003eAWC\u003c/a\u003e, \u003ca href=\"https://www.esri.com/en-us/home\"\u003eESRI\u003c/a\u003e";
  /// IEM RADAR ///
  var iem_conus_base_refl = L.tileLayer.wms(
      "https://mesonet.agron.iastate.edu/cgi-bin/wms/nexrad/n0q.cgi?",
      {"attribution": "", "format": "image/png", "layers": "nexrad-n0q", "opacity": 0.55, "styles": "", "time": radarTime(), "transparent": true, "zIndex":"10", "version": "1.1.1", "interactive": true}
  );

  /// IEM MRMS ///
  var MRMS_refl = L.tileLayer("http://mesonet.agron.iastate.edu/cache/tile.py/1.0.0/q2-hsr-900913/{z}/{x}/{y}.png",{"opacity":"0.7","transparent": true, "zIndex":"12", "updateWhenIdle": true,});


  /////////////// GOES CONUS //////////////////////
  var g16_conus_ch13 = L.tileLayer.wms(
      "https://mesonet.agron.iastate.edu/cgi-bin/wms/goes_east.cgi?",
      {"attribution": "", "format": "image/png", "layers": "conus_ch13", "opacity": 0.65, "styles": "", "time": radarTime(), "transparent": true, "zIndex": "10", "version": "1.1.1"}
  );

  var g16_conus_ch2 = L.tileLayer.wms(
      "https://mesonet.agron.iastate.edu/cgi-bin/wms/goes_east.cgi?",
      {"attribution": "", "format": "image/png", "layers": "conus_ch02", "opacity": 0.75, "styles": "", "time": radarTime(), "transparent": true, "zIndex":"10", "version": "1.1.1"}
  );

  var g16_conus_ch5 = L.tileLayer.wms(
      "https://mesonet.agron.iastate.edu/cgi-bin/wms/goes_east.cgi?",
      {"attribution": "", "format": "image/png", "layers": "conus_ch05", "opacity": 0.75, "styles": "", "time": radarTime(), "transparent": true, "zIndex":"10", "version": "1.1.1"}
  );

  var g16_conus_ch8 = L.tileLayer.wms(
      "https://mesonet.agron.iastate.edu/cgi-bin/wms/goes_east.cgi?",
      {"attribution": "", "format": "image/png", "layers": "conus_ch08", "opacity": 0.75, "styles": "", "time": radarTime(), "transparent": true, "zIndex":"10", "version": "1.1.1"}
  );

  var g16_conus_ch9 = L.tileLayer.wms(
      "https://mesonet.agron.iastate.edu/cgi-bin/wms/goes_east.cgi?",
      {"attribution": "", "format": "image/png", "layers": "conus_ch09", "opacity": 0.75, "styles": "", "time": radarTime(), "transparent": true, "zIndex":"10", "version": "1.1.1"}
  );

  var g16_conus_ch10 = L.tileLayer.wms(
      "https://mesonet.agron.iastate.edu/cgi-bin/wms/goes_east.cgi?",
      {"attribution": "", "format": "image/png", "layers": "conus_ch10", "opacity": 0.75, "styles": "", "time": radarTime(), "transparent": true, "zIndex":"10", "version": "1.1.1"}
  );

  /////////////// GOES MESO 1 //////////////////////
  var g16_m1_ch13 = L.tileLayer.wms(
      "https://mesonet.agron.iastate.edu/cgi-bin/wms/goes_east.cgi?",
      {"attribution": "", "format": "image/png", "layers": "mesoscale-1_ch13", "opacity": 0.65, "styles": "", "time": radarTime(), "transparent": true, "zIndex":"10", "version": "1.1.1"}
  );

  var g16_m1_ch2 = L.tileLayer.wms(
      "https://mesonet.agron.iastate.edu/cgi-bin/wms/goes_east.cgi?",
      {"attribution": "", "format": "image/png", "layers": "mesoscale-1_ch02", "opacity": 0.75, "styles": "", "time": radarTime(), "transparent": true, "zIndex":"10", "version": "1.1.1"}
  );

  var g16_m1_ch10 = L.tileLayer.wms(
      "https://mesonet.agron.iastate.edu/cgi-bin/wms/goes_east.cgi?",
      {"attribution": "", "format": "image/png", "layers": "mesoscale-1_ch10", "opacity": 0.75, "styles": "", "time": radarTime(), "transparent": true, "zIndex":"10", "version": "1.1.1"}
  );

  /////////////// GOES MESO 2 //////////////////////
  var g16_m2_ch13 = L.tileLayer.wms(
      "https://mesonet.agron.iastate.edu/cgi-bin/wms/goes_east.cgi?",
      {"attribution": "", "format": "image/png", "layers": "mesoscale-2_ch13", "opacity": 0.65, "styles": "", "time": radarTime(), "transparent": true, "zIndex":"10", "version": "1.1.1"}
  );

  var g16_m2_ch2 = L.tileLayer.wms(
      "https://mesonet.agron.iastate.edu/cgi-bin/wms/goes_east.cgi?",
      {"attribution": "", "format": "image/png", "layers": "mesoscale-2_ch02", "opacity": 0.75, "styles": "", "time": radarTime(), "transparent": true, "zIndex":"10", "version": "1.1.1"}
  );

  var g16_m2_ch10 = L.tileLayer.wms(
      "https://mesonet.agron.iastate.edu/cgi-bin/wms/goes_east.cgi?",
      {"attribution": "", "format": "image/png", "layers": "mesoscale-2_ch10", "opacity": 0.75, "styles": "", "time": radarTime(), "transparent": true, "version": "1.1.1"}
  );

  ///////////////  BASE LAYERS /////////////////
  var dark = L.tileLayer(
      "https://cartodb-basemaps-{s}.global.ssl.fastly.net/dark_all/{z}/{x}/{y}.png",
      {"attribution": attrib, "detectRetina": false, "maxNativeZoom": 18, "maxZoom": 18, "minZoom": 0, "noWrap": false, "opacity": 1, "subdomains": "abc", "tms": false}
  ).addTo(map);

  var light = L.tileLayer(
      "https://stamen-tiles-{s}.a.ssl.fastly.net/toner/{z}/{x}/{y}.png",
      {"attribution": attrib, "detectRetina": false, "maxNativeZoom": 18, "maxZoom": 18, "minZoom": 0, "noWrap": false, "opacity": 1, "subdomains": "abc", "tms": false}
  );

  var osm = L.tileLayer(
      "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
      {"attribution": attrib, "detectRetina": false, "maxNativeZoom": 18, "maxZoom": 18, "minZoom": 0, "noWrap": false, "opacity": 1, "subdomains": "abc", "tms": false}
  );

  var esri_phyiscal = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Physical_Map/MapServer/tile/{z}/{y}/{x}', {
  	attribution: attrib,
  	maxZoom: 8
  });

  var world_imagery = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
  	attribution: attrib
  });

  var esri_map = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Specialty/DeLorme_World_Base_Map/MapServer/tile/{z}/{y}/{x}', {
  	attribution: attrib,
  	minZoom: 1,
  	maxZoom: 11
  });

  var smoothdark = L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', {
  	maxZoom: 19,
  	attribution: attrib
  });

  /////////////  ADDITIONAL PRODCUTS //////////////////////
  var interstates = new L.Shapefile("{% static 'geo/interstate/interstate_shapefile' %}",{"opacity":"0.9", "color":"#25FF34", "weight":"0.8"})
  var cwa_boundaries = new L.Shapefile("{% static '/geo/boundaries/cwa/cwa' %}",{"opacity":"0.9", "color":"#d6d126", "fillOpacity":"0.0", "weight":"0.95"})
  var spc_day1_cat = new L.layerGroup();
  var fire_day1 = new L.layerGroup();
  var current_warnings = new L.layerGroup();
  var current_hazards = new L.layerGroup();
  var convective_watches = new L.layerGroup();
  var surface_stations = L.featureGroup();


  ///////////// Zoom control ///////////
  var ZoomControl = L.control.zoom({
       position:'topleft'
  }).addTo(map);

  ////////// Drawing Tools //////////////

  var drawnItems = new L.featureGroup();
  map.addLayer(drawnItems);

  drawControl = new L.Control.Draw({
      edit: {
          featureGroup: drawnItems,
          poly: {
              allowIntersection: false
          }
      },
      draw: {
          polygon: {
              allowIntersection: false,
              showArea: true
          },
          marker: true,
          circlemarker: false,
      }
  }).addTo(map);

  var draw_color = 'rgba(38,59,246,1.0)';
  map.on(L.Draw.Event.CREATED, function (event) {
    var layer = event.layer;
    layer.options.color = draw_color;
    layer.options.fillOpacity = 0.0;
    layer.options.weight = 3.0;
    layer.options.opacity = 1.0;
      // var layer = event.layer;
    drawnItems.addLayer(layer);
  });

  /////////////// LAYER CONTROL ////////////////
  var layer_control = {
      base_layers : {
          "Dark (default)" : dark,
          "Light" : light,
          "Open Street Map" : osm,
          "World Imagery": world_imagery,
          "ESRI Map": esri_map,
          "ESRI Physical": esri_phyiscal,
          "Smooth Dark": smoothdark,
      },
      overlays :  {
        "State Borders":state_boundary,
        "County Borders":district_boundary,
        "CWA Boundaries": cwa_boundary, // was cwa_boundaries
        "Interstates":interstates,
        //"GLM": glm_strikes,
      },
  };
  var LayerControl = L.control.layers(
      layer_control.base_layers,
      layer_control.overlays,
      {"autoZIndex": true, "collapsed": true, "position": "topright"}
  ).addTo(map);

////////////////////////////////// Drawing Color Control ///////////////////////////////////
  function changeColor(color){
    globalThis.draw_color = color.toRGBAString();
  }
///////////////////////////////// TEXT CONTROL //////////////////////////////////////////////
  // Lat lon text
  L.Control.textbox = L.Control.extend({
    onAdd: function(map) {
      var text = L.DomUtil.create('div');
      text.id = "LatLonLabel";
      text.innerHTML = "<p id='latlonlabel' style='color: white; text-shadow: 1px 1px black; font-size:15px;'></p>";
      return text;
    },
    onRemove: function(map) {
      // nothing?
    }
  });
  L.control.textbox = function(opts) { return new L.Control.textbox(opts);}
  L.control.textbox({position: 'bottomright'}).addTo(map);

  // time stamp text
  L.Control.textbox = L.Control.extend({
    onAdd: function(map) {
      var text = L.DomUtil.create('div');
      text.id = "info text";
      text.innerHTML = "<p id='timestamp' style='color: white; text-shadow: 1px 1px black; font-size:15px;'></p>";
      return text;
    },
    onRemove: function(map) {
      // nothing?
    }
  });
  L.control.textbox = function(opts) { return new L.Control.textbox(opts);}
  L.control.textbox({position: 'bottomleft'}).addTo(map);
///////////////////////////////// TIME DISPLAY //////////////////////////////////////////////
  function changeValidTime(map){
    console.log("Valid Time Changed");
    interval = 10;
    var times = createTimeArray(interval);
    var currentIndex = 0;
    obj = document.getElementById('validtimestamp');
    obj.innerHTML = "Image ["+(10-currentIndex).toString()+"/"+interval.toString()+"] <br>"+times[currentIndex]+" | Valid Time";
    document.addEventListener("keydown", (event) => {
        if (event.keyCode == 37){
          currentIndex = currentIndex + 1;
          if (currentIndex == times.length){
            currentIndex = 0;
          }
        }
        else if (event.keyCode == 39) {
          currentIndex = currentIndex - 1;
          if (currentIndex < 0){
            currentIndex = times.length-1;
          }
        }
        map.eachLayer(function(layer){
          try{
            console.log(iem_conus_base_refl);
            //layer.setParams({"time":times[currentIndex]});
            //console.log(iem_conus_base_refl);
          }
          catch(err){
            console.log("Could not set time for layer.");
          }
        });

        obj = document.getElementById('validtimestamp');
        obj.innerHTML = "Image ["+(10-currentIndex).toString()+"/"+interval.toString()+"] <br>"+times[currentIndex]+" | Valid Time";
    }); // end function
  } // end changeTime
///////////////////////////////// CHANGE/UPDATE RADAR //////////////////////////////////////////////
  function changeRadar(map, rad){
    //var rad = document.getElementById("RadarSelect").value;
    //console.log(map.eachLayer());
    if (rad == "NONE"){
      iem_conus_base_refl.remove();;
      MRMS_refl.remove();
    }

    else if (rad === "conus_base_refl") {
      iem_conus_base_refl.addTo(map);
      MRMS_refl.remove();
      setInterval(function(){iem_conus_base_refl.setParams({"time":radarTime()},false)}, (300*1000));
    }

    else if (rad === "MRMS") {
      MRMS_refl.addTo(map);
      iem_conus_base_refl.remove();
      setInterval(function(){MRMS_refl.redraw()}, (120*1000));
    }

    else {
      iem_conus_base_refl.remove();
      MRMS_refl.remove();
    }
  }
///////////////////////////////// CHANGE SAT //////////////////////////////////////////////
  function changeSat(map,rad){
    console.log("Updating Satellite Imagery to "+rad);
    if (rad == "NONE"){
      g16_conus_ch2.remove();
      g16_conus_ch5.remove();
      g16_conus_ch8.remove();
      g16_conus_ch9.remove();
      g16_conus_ch10.remove();
      g16_conus_ch13.remove();
      g16_m1_ch2.remove();
      g16_m1_ch10.remove();
      g16_m1_ch13.remove();
      g16_m2_ch2.remove();
      g16_m2_ch10.remove();
      g16_m2_ch13.remove();
    }

    else if (rad === "G16ch2") {
      g16_conus_ch2.addTo(map);
      g16_conus_ch5.remove();
      g16_conus_ch8.remove();
      g16_conus_ch9.remove();
      g16_conus_ch10.remove();
      g16_conus_ch13.remove();
      g16_m1_ch2.remove();
      g16_m1_ch10.remove();
      g16_m1_ch13.remove();
      g16_m2_ch2.remove();
      g16_m2_ch10.remove();
      g16_m2_ch13.remove();
      g16_conus_ch2.setOpacity(0.75);
      setInterval(function(){g16_conus_ch2.setParams({"time":radarTime()},false)}, (300*1000));
    }
    else if (rad === "G16ch13") {
      g16_conus_ch13.addTo(map);
      g16_conus_ch2.remove();
      g16_conus_ch5.remove();
      g16_conus_ch8.remove();
      g16_conus_ch9.remove();
      g16_conus_ch10.remove();
      g16_m1_ch2.remove();
      g16_m1_ch10.remove();
      g16_m1_ch13.remove();
      g16_m2_ch2.remove();
      g16_m2_ch10.remove();
      g16_m2_ch13.remove();
      g16_conus_ch13.setOpacity(0.75);
      setInterval(function(){g16_conus_ch13.setParams({"time":radarTime()},false)}, (300*1000));
    }

    else if (rad === "G16IRsand") {
      g16_conus_ch13.remove(); // these 1st two removals are needed for a clean look.
      g16_conus_ch2.remove();
      g16_conus_ch5.remove();
      g16_conus_ch8.remove();
      g16_conus_ch9.remove();
      g16_conus_ch10.remove();
      g16_conus_ch13.addTo(map);
      g16_conus_ch2.addTo(map);
      g16_m1_ch2.remove();
      g16_m1_ch10.remove();
      g16_m1_ch13.remove();
      g16_m2_ch2.remove();
      g16_m2_ch10.remove();
      g16_m2_ch13.remove();
      g16_conus_ch13.setOpacity(1.0);
      g16_conus_ch2.setOpacity(0.7);
      setInterval(function(){g16_conus_ch13.setParams({"time":radarTime()},false)}, (300*1000));
      setInterval(function(){g16_conus_ch2.setParams({"time":radarTime()},false)}, (300*1000));
    }

    else if (rad === "G16ch5") {
      g16_conus_ch13.remove();
      g16_conus_ch2.remove();
      g16_conus_ch5.addTo(map);
      g16_conus_ch8.remove();
      g16_conus_ch9.remove();
      g16_conus_ch10.remove();
      g16_m1_ch2.remove();
      g16_m1_ch10.remove();
      g16_m1_ch13.remove();
      g16_m2_ch2.remove();
      g16_m2_ch10.remove();
      g16_m2_ch13.remove();
      setInterval(function(){g16_conus_ch5.setParams({"time":radarTime()},false)}, (300*1000));
    }

    else if (rad === "G16ch8") {
      g16_conus_ch13.remove();
      g16_conus_ch2.remove();
      g16_conus_ch5.remove();
      g16_conus_ch8.addTo(map);
      g16_conus_ch9.remove();
      g16_conus_ch10.remove();
      g16_m1_ch2.remove();
      g16_m1_ch10.remove();
      g16_m1_ch13.remove();
      g16_m2_ch2.remove();
      g16_m2_ch10.remove();
      g16_m2_ch13.remove();
      setInterval(function(){g16_conus_ch8.setParams({"time":radarTime()},false)}, (300*1000));
    }

    else if (rad === "G16ch9") {
      g16_conus_ch13.remove();
      g16_conus_ch2.remove();
      g16_conus_ch5.remove();
      g16_conus_ch8.remove();
      g16_conus_ch9.addTo(map);
      g16_conus_ch10.remove();
      g16_m1_ch2.remove();
      g16_m1_ch10.remove();
      g16_m1_ch13.remove();
      g16_m2_ch2.remove();
      g16_m2_ch10.remove();
      g16_m2_ch13.remove();
      setInterval(function(){g16_conus_ch9.setParams({"time":radarTime()},false)}, (300*1000));
    }

    else if (rad === "G16ch10") {
      g16_conus_ch13.remove();
      g16_conus_ch2.remove();
      g16_conus_ch5.remove();
      g16_conus_ch8.remove();
      g16_conus_ch9.remove();
      g16_conus_ch10.addTo(map);
      g16_m1_ch2.remove();
      g16_m1_ch10.remove();
      g16_m1_ch13.remove();
      g16_m2_ch2.remove();
      g16_m2_ch10.remove();
      g16_m2_ch13.remove();
      setInterval(function(){g16_conus_ch10.setParams({"time":radarTime()},false)}, (300*1000));
    }

    else if (rad === "G16ch2m1") {
      g16_conus_ch2.remove();
      g16_conus_ch5.remove();
      g16_conus_ch8.remove();
      g16_conus_ch9.remove();
      g16_conus_ch10.remove();
      g16_conus_ch13.remove();
      g16_m1_ch2.addTo(map);
      g16_m1_ch10.remove();
      g16_m1_ch13.remove();
      g16_m2_ch2.remove();
      g16_m2_ch10.remove();
      g16_m2_ch13.remove();
      g16_m2_ch13.setOpacity(0.75);
      setInterval(function(){g16_conus_ch2.setParams({"time":radarTime()},false)}, (60*1000));
    }
    else if (rad === "G16ch13m1") {
      g16_conus_ch13.remove();
      g16_conus_ch2.remove();
      g16_conus_ch5.remove();
      g16_conus_ch8.remove();
      g16_conus_ch9.remove();
      g16_conus_ch10.remove();
      g16_m1_ch2.remove();
      g16_m1_ch10.remove();
      g16_m1_ch13.addTo(map);
      g16_m2_ch2.remove();
      g16_m2_ch10.remove();
      g16_m2_ch13.remove();
      g16_m1_ch13.setOpacity(0.75);
      setInterval(function(){g16_conus_ch13.setParams({"time":radarTime()},false)}, (60*1000));
    }

    else if (rad === "G16IRsandm1") {
      g16_conus_ch13.remove(); // these 1st two removals are needed for a clean look.
      g16_conus_ch2.remove();
      g16_conus_ch5.remove();
      g16_conus_ch8.remove();
      g16_conus_ch9.remove();
      g16_conus_ch10.remove();
      g16_conus_ch2.remove();
      g16_conus_ch13.remove();
      g16_m1_ch13.addTo(map);
      g16_m1_ch2.addTo(map);
      g16_m1_ch10.remove();
      g16_m2_ch2.remove();
      g16_m2_ch10.remove();
      g16_m2_ch13.remove();
      g16_m1_ch13.setOpacity(1.0);
      g16_m1_ch2.setOpacity(0.7);
      setInterval(function(){g16_conus_ch13.setParams({"time":radarTime()},false)}, (60*1000));
      setInterval(function(){g16_conus_ch2.setParams({"time":radarTime()},false)}, (60*1000));
    }

    else if (rad === "G16ch10m1") {
      g16_conus_ch13.remove();
      g16_conus_ch2.remove();
      g16_conus_ch5.remove();
      g16_conus_ch8.remove();
      g16_conus_ch9.remove();
      g16_conus_ch10.remove();
      g16_m1_ch2.remove();
      g16_m1_ch10.addTo(map);
      g16_m1_ch13.remove();
      g16_m2_ch2.remove();
      g16_m2_ch10.remove();
      g16_m2_ch13.remove();
      setInterval(function(){g16_conus_ch10.setParams({"time":radarTime()},false)}, (60*1000));
    }

    else if (rad === "G16ch2m2") {
      g16_conus_ch2.remove();
      g16_conus_ch5.remove();
      g16_conus_ch8.remove();
      g16_conus_ch9.remove();
      g16_conus_ch10.remove();
      g16_conus_ch13.remove();
      g16_m1_ch2.remove();
      g16_m1_ch10.remove();
      g16_m1_ch13.remove();
      g16_m2_ch2.addTo(map);
      g16_m2_ch10.remove();
      g16_m2_ch13.remove();
      g16_m2_ch2.setOpacity(0.75);
      setInterval(function(){g16_conus_ch2.setParams({"time":radarTime()},false)}, (60*1000));
    }
    else if (rad === "G16ch13m2") {
      g16_conus_ch13.remove();
      g16_conus_ch2.remove();
      g16_conus_ch5.remove();
      g16_conus_ch8.remove();
      g16_conus_ch9.remove();
      g16_conus_ch10.remove();
      g16_m1_ch2.remove();
      g16_m1_ch10.remove();
      g16_m1_ch13.remove();
      g16_m2_ch2.remove();
      g16_m2_ch10.remove();
      g16_m2_ch13.addTo(map);
      g16_m2_ch13.setOpacity(0.75);
      setInterval(function(){g16_conus_ch13.setParams({"time":radarTime()},false)}, (60*1000));
    }

    else if (rad === "G16IRsandm2") {
      g16_conus_ch13.remove(); // these 1st two removals are needed for a clean look.
      g16_conus_ch2.remove();
      g16_conus_ch5.remove();
      g16_conus_ch8.remove();
      g16_conus_ch9.remove();
      g16_conus_ch10.remove();
      g16_conus_ch2.remove();
      g16_conus_ch13.remove();
      g16_m1_ch2.remove();
      g16_m1_ch10.remove();
      g16_m1_ch13.remove();
      g16_m2_ch13.addTo(map);
      g16_m2_ch2.addTo(map);
      g16_m2_ch10.remove();
      g16_m2_ch13.setOpacity(1.0);
      g16_m2_ch2.setOpacity(0.7);
      setInterval(function(){g16_conus_ch13.setParams({"time":radarTime()},false)}, (60*1000));
      setInterval(function(){g16_conus_ch2.setParams({"time":radarTime()},false)}, (60*1000));
    }

    else if (rad === "G16ch10m2") {
      g16_conus_ch13.remove();
      g16_conus_ch2.remove();
      g16_conus_ch5.remove();
      g16_conus_ch8.remove();
      g16_conus_ch9.remove();
      g16_conus_ch10.remove();
      g16_m1_ch2.remove();
      g16_m1_ch10.remove();
      g16_m1_ch13.remove();
      g16_m2_ch2.remove();
      g16_m2_ch10.addTo(map);
      g16_m2_ch13.remove();
      setInterval(function(){g16_conus_ch10.setParams({"time":radarTime()},false)}, (300*1000));
    }
    else {
      g16_conus_ch2.remove();
      g16_conus_ch5.remove();
      g16_conus_ch8.remove();
      g16_conus_ch9.remove();
      g16_conus_ch10.remove();
      g16_conus_ch13.remove();
      g16_m1_ch2.remove();
      g16_m1_ch10.remove();
      g16_m1_ch13.remove();
      g16_m2_ch2.remove();
      g16_m2_ch10.remove();
      g16_m2_ch13.remove();
    }
  }
///////////////////////////////// HAZARDS AND OUTLOOKS //////////////////////////////////////////////

/////////////////////// warnings/hazards /////////////////////////
  function createHazards(){
    console.log("Updating Hazards...");
    var times = getHazardTimes();
    let url = '/static/forecasts/hazards/current_hazards/current_hazards_'+times[0]+'.shp';
    var exists = checkFileExists(url);
    if (exists){
      filestring = '/static/forecasts/hazards/current_hazards/current_hazards_'+times[0];
    } else {
      filestring = '/static/forecasts/hazards/current_hazards/current_hazards_'+times[1];
    }
    var hazard_data = new L.Shapefile(filestring,{
      onEachFeature:function(feature,layer){
        let type = feature.properties.PROD_TYPE;
        if (type.includes("Severe Thunderstorm Warning") || type.includes("Tornado Warning") || type.includes("Flash Flood Warning")){
          // do nothing, these are handled elsewhere.
        }
        else if (type.includes("Severe Thunderstorm Watch") || type.includes("Tornado Watch")){
          let color = hazardColor(type);
          let issuance = feature.properties.ISSUANCE.substring(0,10) + " " + feature.properties.ISSUANCE.substring(11,16) + " LT";
          let expiration = feature.properties.EXPIRATION.substring(0,10) + " " + feature.properties.EXPIRATION.substring(11,16) + " LT";
          let wfo = feature.properties.WFO;
          let url = "https://www.spc.noaa.gov/products/watch/";
          let text = `Hazard Type: ${type} <br>
                      Issued by WFO: ${wfo.substring(1)} <br>
                      Start Time: ${issuance} <br>
                      End Time: ${expiration} <br>`
          let ref = `<a href=${url}>More Info Here</a>`;
          text = text + ref;
          layer.bindPopup(text);
          layer.setStyle({"color":color, "weight":"0.3", "opacity":"0.5"});
          convective_watches.addLayer(layer);
        } // end if
        else {
          let color = hazardColor(type);
          let issuance = feature.properties.ISSUANCE.substring(0,10) + " " + feature.properties.ISSUANCE.substring(11,16) + " LT";
          let expiration = feature.properties.EXPIRATION.substring(0,10) + " " + feature.properties.EXPIRATION.substring(11,16) + " LT";
          let wfo = feature.properties.WFO;
          let url = feature.properties.URL;
          let text = `Hazard Type: ${type} <br>
                      Issued by WFO: ${wfo.substring(1)} <br>
                      Start Time: ${issuance} <br>
                      End Time: ${expiration} <br>`
          let ref = `<a href=${url}>More Info Here</a>`;
          text = text + ref;
          layer.bindPopup(text);
          if (type.includes("Warning")){
            layer.setStyle({"color":color, "weight":"0.3", "opacity":"0.5"});
            layer.bringToFront();
          } else {
            layer.setStyle({"color":color, "weight":"0.3", "opacity":"0.5"});
            layer.bringToBack();
          } // end else
          current_hazards.addLayer(layer);
        } // end else
      } // end for each feature
    }); // end shapefile layer
    hazard_data.remove();
    hazard_data.clearLayers();
  } // end function


  function createWarnings(){
    console.log("Updating Warnings...");
    var times = getWarningTimes();
    let url = '/static/forecasts/hazards/current_warnings/current_warnings_'+times[0]+'.shp';
    var exists = checkFileExists(url);
    if (exists){
      filestring2 = '/static/forecasts/hazards/current_warnings/current_warnings_'+times[0];
    } else {
      filestring2 = '/static/forecasts/hazards/current_warnings/current_warnings_'+times[1];
    }
    var warning_data = new L.Shapefile(filestring2,{
      onEachFeature:function(feature,layer){
        let type = feature.properties.PROD_TYPE;
        let color = warnColor(type);
        let issuance = feature.properties.ISSUANCE.substring(0,10) + " " + feature.properties.ISSUANCE.substring(11,16) + " LT";
        let expiration = feature.properties.EXPIRATION.substring(0,10) + " " + feature.properties.EXPIRATION.substring(11,16) + " LT";
        let wfo = feature.properties.WFO;
        let url = feature.properties.URL;
        let text = `Warning Type: ${type} <br>
                    Issued by WFO: ${wfo.substring(1)} <br>
                    Start Time: ${issuance} <br>
                    End Time: ${expiration} <br>`
        let ref = `<a href=${url}>More Info Here</a>`;
        text = text + ref;
        layer.bindPopup(text);
        layer.setStyle({"color":color});
        layer.bringToFront();
        current_warnings.addLayer(layer);
      } // end forEach
    }); // end new shapefile
    warning_data.remove();
    warning_data.clearLayers();
  } // end function


  var hazardTimers = [];
  function changeHaz(map,rad){
    //var rad = document.getElementById("HazSelect").value;
    // clear layers
    current_warnings.clearLayers();
    current_hazards.clearLayers();
    convective_watches.clearLayers();
    // remove layers
    current_warnings.remove();
    current_hazards.remove();
    convective_watches.remove();

    clearTimers(hazardTimers);

    if (rad == "NONE"){
      current_warnings.remove();
      current_hazards.remove();
      convective_watches.remove();
      console.log("Hazards Removed.");
    }
    else if (rad === "all") {
      createHazards();
      createWarnings();
      current_hazards.addTo(map);
      convective_watches.addTo(map);
      current_warnings.addTo(map);
      var allTimer = setInterval(function(){
        convective_watches.clearLayers();
        convective_watches.remove();
        current_hazards.clearLayers();
        current_hazards.remove();
        createHazards();
        current_hazards.addTo(map);
        convective_watches.addTo(map);
      },(15*60*1000)); // update every 15 minutes
      hazardTimers.push(allTimer);
      var warnTimer = setInterval(function(){
        current_warnings.clearLayers();
        current_warnings.remove();
        createWarnings();
        current_warnings.addTo(map);
      },(70*1000)); // update every 70 seconds
      hazardTimers.push(warnTimer);
    }

    else if (rad === "long") {
      createHazards();
      current_hazards.addTo(map);
      var longTimer = setInterval(function(){
        current_hazards.clearLayers();
        current_hazards.remove();
        createHazards();
        current_hazards.addTo(map);
      },(15*60*1000)); // update every 15 minutes
      hazardTimers.push(longTimer);
    }

    else if (rad === "short") {
      createWarnings();
      current_warnings.addTo(map);
      // set refresh timer for warnings
      var warnTimer = setInterval(function(){
        current_warnings.clearLayers();
        current_warnings.remove();
        createWarnings();
        current_warnings.addTo(map);
      },(70*1000)); // update every 70 seconds
      hazardTimers.push(warnTimer);
    }

    else if (rad === "convective") {
      createHazards();
      createWarnings()
      convective_watches.addTo(map);
      current_warnings.addTo(map);
      // set refresh timer for watches
      var watchTimer = setInterval(function(){
        convective_watches.clearLayers();
        convective_watches.remove();
        createHazards();
        convective_watches.addTo(map);
      },(15*60*1000)); // update every 15 minutes
      hazardTimers.push(watchTimer);
      // set refresh timer for warnings
      var warnTimer = setInterval(function(){
        current_warnings.clearLayers();
        current_warnings.remove();
        createWarnings();
        current_warnings.addTo(map);
      },(70*1000)); // update every 70 seconds
      hazardTimers.push(warnTimer);
    }

    else if (rad === "watch") {
      createHazards();
      convective_watches.addTo(map);
      var watchTimer = setInterval(function(){
        convective_watches.clearLayers();
        convective_watches.remove();
        createHazards();
        convective_watches.addTo(map);
      },(15*60*1000)); // update every 15 minutes
      hazardTimers.push(watchTimer);
    }
    else {
      current_warnings.remove();
      current_hazards.remove();
      convective_watches.remove();
    }
  } // end changeHaz
////////////////////////// outlooks /////////////////////////////
  function createOutlooks(){
    console.log("Refreshing Outlooks");
    var day1_cat_data = new L.Shapefile("{% static '/forecasts/outlooks/spc/day1/day1otlk_cat' %}",{
      onEachFeature:function(feature,layer){
        let dn = feature.properties.DN;
        let color = spcCatColor(dn);
        layer.setStyle({"color":color, "opacity":"0.01"});
        spc_day1_cat.addLayer(layer);
      }
    });
    var day1_fire_data = new L.Shapefile("{% static '/forecasts/outlooks/spc_fire/day1/firewx_day1' %}",{
      onEachFeature:function(feature,layer){
        let dn = feature.properties.DN;
        let color = fireCatColor(dn);
        layer.setStyle({"color":color, "opacity":"0.03"});
        fire_day1.addLayer(layer);
      }
    });
  } // end function createOutlooks

  function clearOutlookTimers(Timers){
    len = Timers.length;
    for (i = 0; i < len; i++){
      clearInterval(hazardTimers[i]);
    }
  }

  var outlookTimers = [];
  function changeOut(map,out){
    //var rad = document.getElementById("HazSelect").value;
    // clear layers
    spc_day1_cat.clearLayers();
    fire_day1.clearLayers();
    // remove layers
    spc_day1_cat.remove();
    fire_day1.remove();

    clearTimers(outlookTimers);

    if (out == "NONE"){
      spc_day1_cat.remove();
      fire_day1.remove();
      console.log("Outlooks removed.");
    }
    else if (out === "spcd1cat") {
      createOutlooks();
      spc_day1_cat.addTo(map);
      var spcd1catTimer = setInterval(function(){
        spc_day1_cat.clearLayers();
        spc_day1_cat.remove();
        createOutlooks();
        spc_day1_cat.addTo(map);
      },(30*60*1000)); // update every 30 minutes
      outlookTimers.push(spcd1catTimer);
    }
    else if (out === "spcd1fire") {
      createOutlooks();
      fire_day1.addTo(map);
      var fired1Timer = setInterval(function(){
        fire_day1.clearLayers();
        fire_day1.remove();
        createOutlooks();
        fire_day1.addTo(map);
      },(30*60*1000)); // update every 30 minutes
      outlookTimers.push(fired1Timer);
    }
    else {
      spc_day1_cat.remove();
      fire_day1.remove();
    }
  } // end function changeOut
///////////////////////////////// MAP VIEW //////////////////////////////////////////////
  function changeMapView(map,newView){
    // changes the map view based on menu selection
    //var newView = document.getElementById("MapView").value;
    console.log(newView);

    if (newView === "CONUS"){
      var center = L.latLng(40.0, -100.0);
      var zoom = 5;
      map.setView(center,zoom);
    }
    else if (newView == "NORTHAM") {
      var center = L.latLng(48.0, -101.0);
      var zoom = 4;
      map.setView(center,zoom);
    }
    else if (newView == "WORLD") {
      var center = L.latLng(35.0, -18.0);
      var zoom = 2;
      map.setView(center,zoom);
    }
    else if (newView == "NW") {
      var center = L.latLng(45.0, -117.0);
      var zoom = 7;
      map.setView(center,zoom);
    }
    else if (newView == "SW") {
      var center = L.latLng(36.0, -115.0);
      var zoom = 7;
      map.setView(center,zoom);
    }
    else if (newView == "SP") {
      var center = L.latLng(35.0, -97.0);
      var zoom = 7;
      map.setView(center,zoom);
    }
    else if (newView == "SE") {
      var center = L.latLng(32.0, -85.0);
      var zoom = 7;
      map.setView(center,zoom);
    }
    else if (newView == "NE") {
      var center = L.latLng(41.0, -76.0);
      var zoom = 7;
      map.setView(center,zoom);
    }
    else if (newView == "MW") {
      var center = L.latLng(41.0, -87.0);
      var zoom = 7;
      map.setView(center,zoom);
    }
    else if (newView == "CP") {
      var center = L.latLng(40.0, -98.0);
      var zoom = 7;
      map.setView(center,zoom);
    }
    else if (newView == "NP") {
      var center = L.latLng(47.0, -100.0);
      var zoom = 7;
      map.setView(center,zoom);
    }
    else if (newView == "CR") {
      var center = L.latLng(41.0, -108.0);
      var zoom = 7;
      map.setView(center,zoom);
    }
  }

  //// HMMM ////
  // script that controls the layer update
  window.onload = function () {
      time = 300 * 1000;
      //changeValidTime(map); // initialize
      setInterval(clockAndLabel,1000);
      //setInterval(changeValidTime(map),300*1000);
      //setInterval(function(){updateRadar(iem_conus_base_refl)}, time);
  };
///////////////////////////////// SURFACE OBS //////////////////////////////////////////////
  obsTimers = []
  sfc_stations_displayed = false;
  function updateSFC(obsType){
    globalThis.obsType;
    clearTimers(obsTimers);
    if (obsType == "NONE"){ // if NONE, just remove all obs
      console.log("Removed surface obs.");
      sfc_stations_displayed = false;
      surface_stations.eachLayer(function(layer){
        map.removeLayer(layer);
      });
      surface_stations.clearLayers();
    }
    else {
      sfc_stations_displayed = true;
      // clear out the old layers and data
      surface_stations.eachLayer(function(layer){
        map.removeLayer(layer);
      });
      surface_stations.clearLayers();
      // get new data based on zoom level
      getBulkObs(obsType);
      // plot the new data on the map
      surface_stations.addTo(map);
      // only show the obs that are in the current view.
      let zoom = map.getZoom();
      surface_stations.eachLayer(function(layer){
        let isVisible = map.getBounds().contains(layer.getLatLng());
        if ((isVisible) && (zoom >= 0)){
          map.addLayer(layer);
        }
        else {
          map.removeLayer(layer);
        } // end else
      }); // end station loop

      var obsTimer = setInterval(function(){
        // timer function to auto-update the surface obs.
        updateSFC(obsType);
      },(300*1000));
      obsTimers.push(obsTimer);
    } // end if obsType

    //////////////// Handle obs on pan ////////////////////
    map.on('dragend', function(obsType){
      if (obsType != "NONE"){
        let zoom = map.getZoom();
        surface_stations.eachLayer(function(layer){
          let isVisible = map.getBounds().contains(layer.getLatLng());
          if ((isVisible) && (zoom >= 0)){
            map.addLayer(layer);
          } // end if
          else {
            map.removeLayer(layer);
          } // end else
        }); // end for each layer in surface_stations
      } // end if
      else {
        surface_stations.eachLayer(function(layer){
          map.removeLayer(layer);
        });
        surface_stations.clearLayers();
      } // end else
    }) // end map.on(pan)

    //////////////// Handle obs on zoom ////////////////////
    map.on('zoomend', function(obsType){
      if (obsType != "NONE"){
        let zoom = map.getZoom();
        surface_stations.eachLayer(function(layer){
          let isVisible = map.getBounds().contains(layer.getLatLng());
          if ((isVisible) && (zoom >= 7)){
            map.addLayer(layer);
          } // end if
          else {
            map.removeLayer(layer);
          } // end else
        }); // end for each layer in surface_stations
      } // end if
      else {
        surface_stations.eachLayer(function(layer){
          map.removeLayer(layer);
        });
        surface_stations.clearLayers();
      } // end else
    }) // end map.on(zoom)
  } // end updateSFC function

  function getBulkObs(type){
    // REQUEST SECTION
    var stations = {{ site_list | safe }};
    var request = new XMLHttpRequest();
    request.overrideMimeType("application/xml");
    request.open("GET","{% static '/data/metars.cache.xml' %}", false);
    //request.setRequestHeader("Content-Type","text/xml");
    request.send(null);
    var doc = request.responseXML;
    var root = doc.childNodes[0];
    var metars = root.children[6];
    for (i=0;i<metars.children.length;i++){
      var stid = metars.children[i].getElementsByTagName("station_id")[0].textContent;
      if (stations.includes(stid)){
        try {
          var lat = parseFloat(metars.children[i].getElementsByTagName("latitude")[0].textContent);
          var lon = parseFloat(metars.children[i].getElementsByTagName("longitude")[0].textContent);
          var tc = parseFloat(metars.children[i].getElementsByTagName("temp_c")[0].textContent);
          var tdc = parseFloat(metars.children[i].getElementsByTagName("dewpoint_c")[0].textContent);
          var metar = metars.children[i].getElementsByTagName("raw_text")[0].textContent;
          var wspd = parseFloat(metars.children[i].getElementsByTagName("wind_speed_kt")[0].textContent);
          var wdir = parseFloat(metars.children[i].getElementsByTagName("wind_dir_degrees")[0].textContent);
          var temp = C2F(tc);
          var dewp = C2F(tdc);
          var relh = RH(tc,tdc);

          try{
            var visb = parseFloat(metars.children[i].getElementsByTagName("visibility_statute_mi")[0].textContent);
          } catch{
            var visb = -999;
          }

          try{
            var mslp = parseFloat(metars.children[i].getElementsByTagName("sea_level_pressure_mb")[0].textContent);
          } catch{
            var mslp = -999;
          }

          try{
            var flightCat = metars.children[i].getElementsByTagName("flight_category")[0].textContent;
          } catch{
            var flightCat = "Unavailable";
          }

          try{
            var gust = parseFloat(metars.children[i].getElementsByTagName("wind_gust_kt")[0].textContent);
          } catch{
            var gust = 0.0;
          }

          try{
            var wx = metars.children[i].getElementsByTagName("wx_string")[0].textContent;
          } catch{
            var wx = "None";
          }


          text = `Station: ${metars.children[i].getElementsByTagName("station_id")[0].textContent} <br>\
                  Time: ${metars.children[i].getElementsByTagName("observation_time")[0].textContent}<br>\
                  Weather: ${wx}<br>\
                  Temp: ${temp} F <br>\
                  Dewp: ${dewp} F<br>\
                  Rel. Humidity: ${relh}%<br>\
                  Wind Speed: ${wspd} knots <br>\
                  Wind Gust: ${gust} knots <br>\
                  Wind Dir: ${wdir} deg<br>\
                  Visibility: ${visb} mi.<br>\
                  MSLP: ${mslp} mb<br>\
                  Flight Cat: ${flightCat}`;

          if (type =="standard"){
            let temp_color = "red";
            let dewp_color = "green";
            let wind_color = "white";
            addTempDewpPair(lat,lon,temp,dewp,temp_color,dewp_color);
            addMETARText(lat,lon,text);
            createWindBarb(lat,lon,wspd,wdir,wind_color);
          }

          else if (type == "black") {
            let theme = "black";
            let temp_color = theme;
            let dewp_color = theme;
            let wind_color = theme;
            addTempDewpPair(lat,lon,temp,dewp,temp_color,dewp_color);
            addMETARText(lat,lon,text);
            createWindBarb(lat,lon,wspd,wdir,wind_color);
          }

          else if (type == "white") {
            let theme = "white";
            let temp_color = theme;
            let dewp_color = theme;
            let wind_color = theme;
            addTempDewpPair(lat,lon,temp,dewp,temp_color,dewp_color);
            addMETARText(lat,lon,text);
            createWindBarb(lat,lon,wspd,wdir,wind_color);
          }

          else if (type == "RLT") {
            let temp = C2F(tc);
            let dewp = C2F(tdc);
            let temp_color = tempColor(temp);
            let dewp_color = dewpColor(dewp);
            let wind_color = "white";
            addTempDewpPair(lat,lon,temp,dewp,temp_color,dewp_color);
            addMETARText(lat,lon,text);
            createWindBarb(lat,lon,wspd,wdir,wind_color);
          }

          else if (type == "TEMP") {
            let temp_color = tempColor(temp);
            addSingleValue(lat, lon, temp ,temp_color);
            addMETARText(lat, lon, text);
          }

          else if (type == "DEWP") {
            let dewp_color = dewpColor(dewp);
            addSingleValue(lat, lon, dewp,dewp_color);
            addMETARText(lat,lon,text);
          }

          else if (type == "MSLP") {
            if (mslp > 0.0){
              color = mslpColor(mslp);
              addSingleValue(lat,lon,mslp,color);
              addMETARText(lat,lon,text);
            }
          }

          else if (type == "WIND") {
            let wind_color = windColor(wspd);
            createWindBarb(lat,lon,wspd,wdir,wind_color);
            addMETARText(lat,lon,text);
          }

          else if (type == "FIRE") {
            let relh_color = relhColor(relh);
            let wind_color = "white";
            createWindBarb(lat,lon,wspd,wdir,wind_color);
            addSingleValue(lat,lon,relh,relh_color);
            addMETARText(lat,lon,text);
          }

          else if (type == "VISB") {
            let visb_color = visbColor(visb);
            addSingleValue(lat,lon,visb,visb_color);
            addMETARText(lat,lon,text);
          }

          else if (type == "AVIATION") {
            let cat_color = flightCatColor(flightCat);
            addCircleMarker(lat,lon,cat_color);
            addMETARText(lat,lon,text);
          }
          // end options
        }
        catch {
          //console.log("Error parsing METAR data.");
        } // end try/catch
      } // end if
    } // end for
    // display the data
    surface_stations.eachLayer(function(layer){
      map.addLayer(layer);
    }); // end for each layer in surface_stations
  } // end function


  function createWindBarb(latitude,longitude,wspd,dir,color){
    if (wspd < 5.0){
      var windbarb = new L.circleMarker([latitude,longitude], {radius:5, weight: 1.0, opacity: 1.0, color: color, fillColor: "none", fillOpacity: 0.0});
    } else {
      var icon = L.WindBarb.icon({lat: latitude, deg: dir, speed: wspd, pointRadius: 0, strokeWidth: 2, strokeLength: 18, barbSpaceing: 4, barbHeight: 10, fillColor: 'gray', barbColor: color});
      var windbarb = L.marker([latitude,longitude], {icon: icon});
    }
    windbarb.addTo(surface_stations);
  }

  function addMETARText(latitude,longitude,text){
    var textmarker = new L.marker([latitude, longitude], { opacity: 0.0 });
    textmarker.on('mouseover', function(){
      document.getElementById("metardata").innerHTML = text;
    });
    textmarker.on('mouseout', function(){
      document.getElementById("metardata").innerHTML = "";
    });
    textmarker.addTo(surface_stations);
  }

  function addTempDewpPair(lat,lon,temp,dewp,temp_color,dewp_color){
    var doubleMarker = L.marker([lat,lon],{
      icon: L.divIcon({
        className: 'text-label',
        html: `<p style="color:${temp_color}; margin-bottom:0;">${temp}</p><p style="color:${dewp_color}; margin-top:0;">${dewp}</p>`,
        iconSize: [40,40] // [18,40]
      })
    });
    doubleMarker.addTo(surface_stations);

  }

  function addSingleValue(lat,lon,value,value_color){
    var singleMarker = L.marker([lat,lon],{
      icon: L.divIcon({
        className: 'text-label',
        html: `<p style="color:${value_color}; margin-bottom:0;">${value}</p>`,
        iconSize: [18,18]
      })
    });
    singleMarker.addTo(surface_stations);
  }

  function addCircleMarker(lat,lon,circle_color){
    var marker = new L.circleMarker([lat, lon], { radius: 7, color: "black", weight: 2, opacity: 1.0, fillColor: circle_color, fillOpacity: 0.75 }); //opacity may be set to zero
    marker.addTo(surface_stations);
  }
////////////////////////////////////// showing/hiding sfc data tooltip ///////////////////////////////////////////////////////////
  function changeMetarDisplay(){
    globalThis.metarDisplay = !metarDisplay;
    if (metarDisplay && sfc_stations_displayed){
      document.getElementById("showmetar").innerHTML = "Display sfc data on hover: ON";
      document.getElementById("metarDataHolder").classList.add("visible");
    } else {
      document.getElementById("showmetar").innerHTML = "Display sfc data on hover: OFF";
      document.getElementById("metarDataHolder").classList.remove("visible");
    }
  }
///////////////////////////////// Sat, Rad, GLM, sfc obs, Updates //////////////////////////////////////////////

  setInterval(function(){
    var currentTime = dataTimeFormat(new Date);
    var validTime = dataTimeFormat(new Date(Math.floor( new Date() / 300000) * 300000));
    console.log(currentTime,validTime);
    if (currentTime == validTime){
      times = createTimeArray(interval);
      displayGLM();
    } // end if
  },(60*1000));

///////////////////////////////////////////////////////////////////////////////
// attributions
// <div>Icons made by <a href="https://www.freepik.com" title="Freepik">Freepik</a> from <a href="https://www.flaticon.com/" title="Flaticon">www.flaticon.com</a></div>
//<div>Icons made by <a href="https://www.flaticon.com/authors/roundicons" title="Roundicons">Roundicons</a> from <a href="https://www.flaticon.com/" title="Flaticon">www.flaticon.com</a></div>
//<div>Icons made by <a href="https://www.flaticon.com/authors/turkkub" title="turkkub">turkkub</a> from <a href="https://www.flaticon.com/" title="Flaticon">www.flaticon.com</a></div>
//<div>Icons made by <a href="https://www.flaticon.com/authors/gregor-cresnar" title="Gregor Cresnar">Gregor Cresnar</a> from <a href="https://www.flaticon.com/" title="Flaticon">www.flaticon.com</a></div>
//<div>Icons made by <a href="https://www.flaticon.com/authors/icongeek26" title="Icongeek26">Icongeek26</a> from <a href="https://www.flaticon.com/" title="Flaticon">www.flaticon.com</a></div>
//<div>Icons made by <a href="https://www.flaticon.com/authors/those-icons" title="Those Icons">Those Icons</a> from <a href="https://www.flaticon.com/" title="Flaticon">www.flaticon.com</a></div>

</script>

{% endblock %}
