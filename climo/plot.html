<!DOCTYPE html>

<html lang="en">

<head>

  {% block content %}
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="">
  <meta name="author" content="">
  <!--<meta http-equiv="refresh" content="300" >-->

  <title>Climate Plots</title>

  <!-- Bootstrap core CSS -->
  {% load static %}
  <!-- Non-Template sytles and JS links -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.4.0/dist/leaflet.css"/>
    <!-- local scripts -->
  <link rel="stylesheet" href="{% static 'climo.css'  %}" />
  <link href="{% static 'vendor/bootstrap/css/bootstrap.min.css' %}" rel="stylesheet">
  <script type="text/javascript" src="{% static 'plotly-2.4.2.min.js' %}"></script>
  <script type="text/javascript" src="{% static 'climo.js' %}"></script>
  <!-- non-local scripts -->
  <script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.4.0/dist/leaflet-src.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

  <style>

  body::after {
    content: "";
    background-image: url("{% static 'raindrops.jpg' %}");
    background-size: cover;
    opacity: 0.6;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    position: absolute;
    z-index: -1;
  }

  </style>

</head>

<body>

  <div id="container">
    <div class="mapholder">
      <div id="map" style="width: 100%; height: 100%;">
          <script>
          // Javascript that controls the map for station selection
          var map = L.map("map").setView([40.0, -96.0], 4);
          var osmAttribution ='Map data &copy; <a href="https://openstreetmap.org">OpenStreetMap</a> contributors';
          L.tileLayer(
                  "https://tile-{s}.openstreetmap.fr/hot/{z}/{x}/{y}.png",
                  {
                          attribution: [
                              osmAttribution,
                          ].join(" | ")
                  }
          ).addTo(map);
          var cirlceSize = 50000.0; //meters
          var opacity = 0.75;
          var circColor = "blue";
          var fillCol = "blue";
          function addCircleMarker(lat,lon){
            var marker = new L.circleMarker([lat, lon], { radius: 10, color: "black", weight: 2, opacity: 1.0, fillColor: fillCol, fillOpacity: 0.75 }); //opacity may be set to zero
            marker.addTo(climo_stations);
          }
          function addStationText(latitude,longitude,text){
            var textmarker = new L.marker([latitude, longitude], { opacity: 0.0 });
            textmarker.bindTooltip(
                `<div>
                     ${text}
                </div>`,
                {direction:'center', permanent: false, offset:[0,0]}
            );
            textmarker.addTo(climo_stations);
            textmarker.addEventListener('click',function(){changeSite(text)});
          }
          /// Markers
          var climo_stations = new L.geoJson();
          climo_stations.addTo(map);
          $.ajax({
          dataType: "json",
          url: "{% static 'climo_stations_prod.json' %}",
          //url: '/static/csv/climo_stations.json',
          success: function(data) {
              $(data).each(function(key, values) {
                  for (site in values){
                    var stid = site
                    var lat = data[site][0];
                    var lon = data[site][1];
                    addCircleMarker(lat,lon);
                    addStationText(lat,lon,site);
                  }
              });
          }
          }).fail(function() {console.log("Failed to load climate sites.")});
          // end of the map javascript
          </script>
      </div><!-- End map -->
    </div><!-- End map holder-->

    <div id=optsHolder class="Options Holder">
      <p id="currentStation" style="color:white">Current Station: None
      <form  style="width: 200px; color:white;">
        Select Variable:
        <select id="VariableSelection">
          <option value="tmpf" selected>Temperature</option>
          <option value="dwpf">Dewpoint</option>
          <option value="mslp">Mean Sea Level Pressure</option>
          <option value="sknt">Wind Speed</option>
          <option value="relh">Relative Humidity</option>
        </select>
      </form>
      <br />
      <h5 id="obsTimestamp" style="color:white">Latest Observation:</h5>
      <table id=CurrentConditionTable>
       <tr>
         <td>Temperature:</td>
         <td id="tempValue">-- F</td>
       </tr>
       <tr>
         <td>Dewpoint:</td>
         <td id="dewpValue">-- F</td>
       </tr>
       <tr>
         <td>Relative Humidity:</td>
         <td id="relhValue">-- %</td>
       </tr>
       <tr>
         <td>Wind Speed:</td>
         <td id="wspdValue">-- knots</td>
       </tr>
       <tr>
         <td>MSLP:</td>
         <td id="mslpValue">-- mb</td>
       </tr>
     </table>
    </div><!-- End Options holder -->

    <div id="plotHolder">
    </div> <!-- end of plot holder-->

  </div> <!-- end of contianer div -->

  <script>
    // Initialize the current value - this makes it a global variable
    globalThis.currentValue = "--";
    ///////////////////////////////////////////////////////////////////////////////////////////////////////
    function initializeClimo(){
      var site = document.getElementById("currentStation").innerHTML.substr(18,3);
      if (site != "one") {
        // output a status update
        var variable = document.getElementById("VariableSelection").value;
        // Request the current observations and use this to plot current value and update table.
        var request = new XMLHttpRequest({mozSystem:true});
        request.open('GET','https://api.weather.gov/stations/K'+site+'/observations/latest?require_qc=true',false)
        request.onload = function() {
          var data = JSON.parse(this.response);
          if (request.status >= 200 && request.status < 400) {
            var timestamp = formatTime(data.properties.timestamp);
            var temp = tempQC(data.properties.temperature.value);
            var dewp = tempQC(data.properties.dewpoint.value);
            var wspd = wspdQC(data.properties.windSpeed.value);
            var mslp = mslpQC(data.properties.seaLevelPressure.value);
            var relh = relhQC(data.properties.relativeHumidity.value);
            // The QC functions all return strings, pass these to the table function
            var obs = [temp,dewp,wspd,mslp,relh,timestamp];
            updateTable(obs); // send the data to the updateTable function
            setCurrentValue(obs,variable,currentValue);
            console.log("Obs table updated.");
          }
          else {
            console.log("No Valid Updates for site "+site);
          }
        }
        request.send()
        // end get Obs section

        // Read the data from the JSON files and pass it to the plot function
        $.ajax({
        dataType: "json",
        url: "{% static '/climate/OKC_tmpf_stats.json' %}",
        //url: '/static/csv/climate/'+site+'_'+variable+'_stats.json',
        success: function(content) {
            plotClimo(site,variable,content);
          } // end success
        }).fail(function() {console.log("Failed to load climate sites.")});
      } // end if
      else {
        console.log("No site selected. Waiting for site selection.");
      } // end else
    } // end function
    ///////////////////////////////////////////////////////////////////////////////////////////////////////
    function plotClimo(site,variable,content){
      var site = "K"+site;
      var dates = quickDates();
      var xvals = [];
      var mean= [];
      var min = [];
      var max = [];
      var tenth = [];
      var twentyfifth = [];
      var seventyfifth = [];
      var ninety = [];

      dates.forEach((date, i) => {
        for (const key in content){
          if (date == formatDate(key)){
            min.push(content[key][0]);
            tenth.push(content[key][1]);
            twentyfifth.push(content[key][2]);
            mean.push(content[key][3]);
            seventyfifth.push(content[key][4]);
            ninety.push(content[key][5]);
            max.push(content[key][6]);
          } // end if
        } // end content for
      }); // end forEach

      // handle a few date/time things
      // var first_year = valid.at(0).substr(0,4);
      // var last_year = valid.at(-1).substr(0,4);
      let currentDate = new Date();
      var currentMonth = currentDate.getMonth() + 1;
      if (currentMonth < 10){
        currentMonth = "0"+currentMonth.toString();
      }
      else {
        currentMonth = currentMonth.toString();
      }
      if (currentDate.getDate() < 10){
        var currentDay = "0"+currentDate.getDate().toString();
      }
      else{
        var currentDay = currentDate.getDate().toString();
      }
      var today = currentMonth + "-" + currentDay;
      var index = Array.prototype.indexOf.call(dates,today);
      console.log("Current Value: "+currentValue.toString());

      // Now start to create the plot
      var minTrace = {
        x: dates,
        y: min,
        mode: 'lines',
        name: 'Min',
        line: {
          color: 'rgb(104,107,195)'
        }
      };

      var tenthTrace = {
        x: dates,
        y: tenth,
        mode: 'lines',
        name: '10%',
        line: {
          color: 'rgb(144,144,144)'
        }
      };

      var twentyfifthTrace = {
        x: dates,
        y: twentyfifth,
        mode: 'lines',
        name: '25%',
        line: {
          color: 'rgb(27,166,55)'
        }
      };

      var meanTrace = {
        x: dates,
        y: mean,
        mode: 'lines',
        name: 'Mean',
        line: {
          color: 'rgb(0,0,0)',
          width: 3
        }
      };

      var seventyfifthTrace = {
        x: dates,
        y: seventyfifth,
        mode: 'lines',
        name: '75%',
        line: {
          color: 'rgb(27,166,55)'
        }
      };

      var ninetyTrace = {
        x: dates,
        y: ninety,
        mode: 'lines',
        name: '90%',
        line: {
          color: 'rgb(144,144,144)'
        }
      };

      var maxTrace = {
        x: dates,
        y: max,
        mode: 'lines',
        name: 'Max',
        line: {
          color: 'rgb(195,104,104)'
        }
      };

      var current = {
        x: [dates[index]],
        y: [currentValue],
        mode: 'markers',
        name: 'Current',
        marker: {
          color: 'rgb(219, 64, 82)',
          size: 12
        }
      }

      // var IQRfill2 = {
      //   x: xvals,
      //   y: mean,
      //   fill: "tonext",
      //   fillcolor: 'rgba(27,166,55,0.3)',
      //   line: {color: "transparent"},
      //   showlegend: false,
      //   type: 'scatter'
      // };

      // var IQRfill1 = {
      //   x: xvals,
      //   y: seventyfifth,
      //   fill: "tonext",
      //   fillcolor: 'rgba(27,166,55,0.3)',
      //   line: {color: "transparent"},
      //   showlegend: false,
      //   type: 'scatter'
      // };

      // get the Y-axis varialbe label
      if (variable == "tmpf"){
        var y_title = "Temperature (F)";
        var title_var = "Temperature";
      }
      else if (variable == "dwpf") {
        var y_title = "Dewpoint (F)";
        var title_var = "Dewpoint";
      }
      else if (variable == "mslp") {
        var y_title = "MSLP (mb)";
        var title_var = "Mean Sea Level Pressure";
      }
      else if (variable == "sknt") {
        var y_title = "Wind Speed (knots)";
        var title_var = "Sustained Wind Speed";
      }
      else if (variable == "relh") {
        var y_title = "Relative Humidity (%)";
        var title_var = "Relative Humidity";
      }
      else {
        console.log("WARNING: Unknown variable! How did this happen?!");
        var y_title = "Unknown";
        var title_var = "Unknown";
      }

      var plotData = [maxTrace,ninetyTrace,seventyfifthTrace,meanTrace,twentyfifthTrace,tenthTrace,minTrace,current];
      var layout = {
        //title: title_var+' Distribution for '+site+' from '+first_year+' to '+last_year,
        title: title_var+' Distribution for '+site,
        xaxis: {
          title: 'Month-Day',
          type: 'category',
          // tickvals: dates,
          tick0: dates.at(0),
          dtick: 15,
          tickangle: 45
        },
        yaxis: {
          title: y_title
        }
      };

      Plotly.newPlot('plotHolder',plotData,layout);
    } // end plotClimo
    ///////////////////////////////////////////////////////////////////////////////////////////////////////

  </script>
  <!-- vendor/bootstrap/js/bootstrap.bundle.min.js -->
  <script src="{% static 'vendor/bootstrap/js/bootstrap.bundle.min.js' %}"></script>

{% endblock %}
</body>

</html>
